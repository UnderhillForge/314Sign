<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Daily Specials</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    html, body { height:100%; overflow:hidden; }
    body {
      background: url('bg/bg1.jpg') center/cover no-repeat;
      font-family: 'Comic Sans MS', cursive;
      color: #fff;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
      display: flex;
      flex-direction: column;
    }
    header {
      background: rgba(0,0,0,0.5);
      padding: 1rem;
      text-align: center;
      /* Responsive header font: scales with viewport width (5vw) between 1.5rem-4rem */
      /* Larger screens get proportionally larger text; clamp() prevents extremes */
      font-size: clamp(1.5rem, 5vw, 4rem);
      font-weight: bold;
    }
    #specials {
      flex: 1;
      /* Responsive padding: scales with viewport width between 1rem-3rem */
      padding: clamp(1rem, 2vw, 3rem);
      /* Responsive specials text: scales with viewport width (3vw) between 1rem-3rem */
      /* 3vw means 3% of screen width; larger TVs get bigger fonts automatically */
      font-size: clamp(1rem, 3vw, 3rem);
      line-height: 1.6;
      overflow-y: auto;
      white-space: pre-wrap;
      -webkit-overflow-scrolling: touch;
    }
  </style>
</head>
<body>
  <header>Specials</header>
  <div id="specials">Loading…</div>

  <script>
  const specialsDiv = document.getElementById('specials');
  let lastText = '';
  let lastEtag = null;

  // Poll interval in milliseconds. Default to 3000ms (3s).
  // This value can be overridden from config.json using one of:
  //  - pollIntervalMs: number (milliseconds)
  //  - pollIntervalSeconds: number (seconds)
  //  - pollInterval: number (seconds)  -- legacy/short key
  let pollIntervalMs = 3000;
  
  // Font scale percentage. Default to 3% of viewport width.
  // Can be overridden via fontScalePercent in config.json.
  let fontScalePercent = 3;

    // --------------------------------------------------------------------
    // 1. Load config.json (once)
    // --------------------------------------------------------------------
    fetch('config.json?' + Date.now())
      .then(r => r.ok ? r.json() : {})
      .then(cfg => {
        // Apply background/font from config if present
        if (cfg.bg)   document.body.style.backgroundImage = `url('bg/${cfg.bg}')`;
        if (cfg.font) document.body.style.fontFamily = cfg.font;

        // Configure poll interval from config (supports multiple keys)
        if (cfg && typeof cfg === 'object') {
          // Prefer explicit milliseconds value if provided
          if (Number.isFinite(cfg.pollIntervalMs)) {
            pollIntervalMs = Number(cfg.pollIntervalMs);
          } else if (Number.isFinite(cfg.pollIntervalSeconds)) {
            pollIntervalMs = Number(cfg.pollIntervalSeconds) * 1000;
          } else if (Number.isFinite(cfg.pollInterval)) {
            // legacy shorthand interpreted as seconds
            pollIntervalMs = Number(cfg.pollInterval) * 1000;
          }

          // Validate sensible range; fall back to default on invalid values
          if (!Number.isFinite(pollIntervalMs) || pollIntervalMs <= 0) {
            pollIntervalMs = 3000;
          }
          
          // Load font scale percentage from config if provided
          if (Number.isFinite(cfg.fontScalePercent)) {
            fontScalePercent = Number(cfg.fontScalePercent);
          }
          
          // Apply font scale by updating CSS custom property
          if (fontScalePercent > 0) {
            const specials = document.getElementById('specials');
            if (specials) {
              specials.style.fontSize = 'clamp(1rem, ' + fontScalePercent + 'vw, 3rem)';
            }
          }
        }
      })
      .catch(() => console.warn('config.json missing – using defaults'))
      .finally(startPolling);

    // --------------------------------------------------------------------
    // 2. Poll specials.txt – ETag-aware, fallback to text compare
    // --------------------------------------------------------------------
    function startPolling() {
      pollSpecials();
    }

    function pollSpecials() {
      fetch('specials.txt?' + Date.now(), {
        cache: 'no-store',
        headers: { 'Cache-Control': 'no-cache' }
      })
        .then(r => {
          if (!r.ok) throw new Error('HTTP ' + r.status);

          const etag = r.headers.get('ETag');
          const hasEtag = etag && etag !== lastEtag;

          // If ETag changed → file changed → read text
          if (hasEtag) {
            lastEtag = etag;
            return r.text();
          }

          // No ETag or same ETag → read text anyway (safe fallback)
          return r.text().then(text => {
            if (text === lastText) {
              // No change → skip DOM update
              return null;
            }
            return text;
          });
        })
        .then(newText => {
          if (newText !== null && newText !== undefined) {
            lastText = newText;
            specialsDiv.textContent = newText.trim() || 'No specials today.';
          }
        })
        .catch(err => {
          console.error('Specials load failed:', err);
          specialsDiv.textContent = 'Error loading specials – retrying…';
        })
        .finally(() => {
          // Use configured poll interval (ms). This keeps a single timeout
          // chain to avoid overlapping polls.
          setTimeout(pollSpecials, pollIntervalMs);
        });
    }

    // --------------------------------------------------------------------
    // 3. Full reload every 5 minutes (catches config/background changes)
    // --------------------------------------------------------------------
    setInterval(() => location.reload(), 5 * 60 * 1000);
  </script>
</body>
</html>