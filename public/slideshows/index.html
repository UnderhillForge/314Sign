<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Slideshow Editor</title>
  <link rel="icon" type="image/svg+xml" href="../favicon.svg" />
  <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
      height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #1a1a1a;
      color: #e0e0e0;
      overscroll-behavior: none;
    }
    .container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      padding: 1rem;
      gap: 1rem;
      padding-top: max(1rem, env(safe-area-inset-top));
      padding-bottom: max(1rem, env(safe-area-inset-bottom));
    }
    h2 {
      font-size: clamp(1.2rem, 4vw, 1.8rem);
      color: #e0e0e0;
      text-align: center;
    }
    .sets-panel {
      background: #2d2d2d;
      padding: 1rem;
      border-radius: 8px;
      flex-shrink: 0;
    }
    .sets-tabs {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-bottom: 1rem;
    }
    .set-tab {
      padding: 0.5rem 1rem;
      background: #1a1a1a;
      border: 2px solid transparent;
      border-radius: 6px;
      color: #b0b0b0;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }
    .set-tab.active {
      border-color: #4a9eff;
      color: #4a9eff;
      background: #2d2d2d;
    }
    .set-controls {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    button {
      padding: 0.5rem 1rem;
      background: #4a9eff;
      color: white;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
      font-size: 0.9rem;
    }
    button:hover { background: #3a8eef; }
    button.secondary {
      background: #555;
    }
    button.secondary:hover { background: #666; }
    button.danger {
      background: #c44;
    }
    button.danger:hover { background: #d55; }
    .slides-list {
      background: #2d2d2d;
      padding: 1rem;
      border-radius: 8px;
      max-height: 300px;
      overflow-y: auto;
    }
    .slide-item {
      background: #1a1a1a;
      padding: 0.75rem;
      margin-bottom: 0.5rem;
      border-radius: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border: 2px solid transparent;
      cursor: pointer;
      transition: all 0.2s;
    }
    .slide-item.active {
      border-color: #4a9eff;
    }
    .slide-item:hover {
      background: #252525;
    }
    .slide-info {
      flex: 1;
    }
    .slide-type {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      background: #4a9eff;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 700;
      margin-right: 0.5rem;
    }
    .slide-actions {
      display: flex;
      gap: 0.25rem;
    }
    .slide-actions button {
      padding: 0.25rem 0.5rem;
      font-size: 0.8rem;
    }
    .editor-panel {
      background: #2d2d2d;
      padding: 1rem;
      border-radius: 8px;
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }
    .form-group label {
      font-weight: 600;
      font-size: 0.9rem;
      color: #ccc;
    }
    .form-group input,
    .form-group select,
    .form-group textarea {
      padding: 0.5rem;
      border-radius: 6px;
      border: 1px solid #555;
      background: #1a1a1a;
      color: #e0e0e0;
      font-size: 0.9rem;
      font-family: inherit;
    }
    .form-group textarea {
      resize: vertical;
      min-height: 100px;
      font-family: 'Monaco', 'Courier New', monospace;
    }
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem;
    }
    @media (max-width: 768px) {
      .form-row {
        grid-template-columns: 1fr;
      }
    }
    .preview-panel {
      background: #000;
      border-radius: 8px;
      min-height: 200px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }
    .preview-content {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      text-align: center;
    }
    .preview-content img,
    .preview-content video {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }
    .wysiwyg-editor {
      background: #2d2d2d;
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      padding: 1rem;
    }
    .slide-thumbnails {
      display: flex;
      gap: 0.5rem;
      overflow-x: auto;
      padding: 0.5rem;
      background: #1a1a1a;
      border-radius: 6px;
      min-height: 80px;
    }
    .slide-thumbnail {
      flex-shrink: 0;
      width: 120px;
      height: 67px;
      background: #000;
      border-radius: 4px;
      border: 2px solid transparent;
      cursor: pointer;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      color: #666;
      transition: all 0.2s;
    }
    .slide-thumbnail.active {
      border-color: #4a9eff;
    }
    .slide-thumbnail:hover {
      border-color: #666;
    }
    .slide-thumbnail.drag-over {
      border-color: #4a9eff;
      background: #2a2a2a;
    }
    .slide-thumbnail .slide-number {
      position: absolute;
      top: 2px;
      left: 2px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 1px 4px;
      border-radius: 2px;
      font-size: 0.7rem;
    }
    .slide-thumbnail .slide-type {
      position: absolute;
      bottom: 2px;
      right: 2px;
      background: rgba(74,158,255,0.8);
      color: white;
      padding: 1px 4px;
      border-radius: 2px;
      font-size: 0.6rem;
      text-transform: uppercase;
    }
    .canvas-container {
      background: #000;
      border-radius: 6px;
      min-height: 300px;
      position: relative;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .canvas-background {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-size: cover;
      background-position: center;
      opacity: 1;
    }
    .canvas-element {
      position: absolute;
      cursor: move;
      user-select: none;
      border: 2px solid transparent;
      transition: border-color 0.2s;
    }
    .canvas-element.selected {
      border-color: #4a9eff;
    }
    .canvas-element:hover {
      border-color: #666;
    }
    .canvas-element.text-element {
      white-space: pre-wrap;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
      max-width: 90%;
      word-wrap: break-word;
    }
    .canvas-element.image-element img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }
    .resize-handle {
      position: absolute;
      width: 8px;
      height: 8px;
      background: #4a9eff;
      border-radius: 50%;
      cursor: nw-resize;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .canvas-element.selected .resize-handle {
      opacity: 1;
    }
    .resize-handle.nw { top: -4px; left: -4px; cursor: nw-resize; }
    .resize-handle.ne { top: -4px; right: -4px; cursor: ne-resize; }
    .resize-handle.sw { bottom: -4px; left: -4px; cursor: sw-resize; }
    .resize-handle.se { bottom: -4px; right: -4px; cursor: se-resize; }
    .toolbar {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      background: #1a1a1a;
      padding: 0.5rem;
      border-radius: 6px;
    }
    .tool-btn {
      padding: 0.5rem 1rem;
      background: #2d2d2d;
      color: #e0e0e0;
      border: 1px solid #555;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.2s;
    }
    .tool-btn:hover {
      background: #3a3a3a;
      border-color: #666;
    }
    .tool-btn.active {
      background: #4a9eff;
      border-color: #4a9eff;
      color: white;
    }
    .properties-panel {
      background: #1a1a1a;
      padding: 1rem;
      border-radius: 6px;
      max-height: 300px;
      overflow-y: auto;
    }
    .properties-panel h4 {
      margin: 0 0 0.5rem 0;
      color: #e0e0e0;
    }
    .property-group {
      margin-bottom: 1rem;
    }
    .property-group label {
      display: block;
      font-weight: 600;
      font-size: 0.8rem;
      color: #ccc;
      margin-bottom: 0.25rem;
    }
    .property-row {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }
    .property-row input[type="number"] {
      width: 80px;
    }
    .color-picker {
      width: 40px;
      height: 30px;
      border: 1px solid #555;
      border-radius: 3px;
      cursor: pointer;
    }
    .delete-btn {
      background: #c44;
      color: white;
      border: none;
      padding: 0.25rem 0.5rem;
      border-radius: 3px;
      cursor: pointer;
      font-size: 0.8rem;
      margin-top: 0.5rem;
    }
    .delete-btn:hover {
      background: #d55;
    }
    .element-selector {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: 3px;
      font-size: 0.8rem;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .canvas-container.editing .element-selector {
      opacity: 1;
    }
    .view-tabs {
      display: flex;
      gap: 0.5rem;
      background: #2d2d2d;
      padding: 0.5rem;
      border-radius: 8px;
      flex-shrink: 0;
    }
    .view-tab {
      flex: 1;
      padding: 0.5rem 0.75rem;
      font-size: 0.9rem;
      font-weight: 600;
      color: #b0b0b0;
      background: #1a1a1a;
      border: 2px solid transparent;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }
    .view-tab.active {
      color: #4a9eff;
      background: #2d2d2d;
      border-color: #4a9eff;
    }
    .view-tab:active { background: #3a3a3a; }
    .toast {
      position: fixed;
      bottom: 2rem;
      left: 50%;
      transform: translateX(-50%);
      background: #28a745;
      color: white;
      padding: 0.75rem 1.5rem;
      border-radius: 6px;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 1000;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      z-index: 2000;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }
    .modal.active {
      display: flex;
    }
    .modal-content {
      background: #2d2d2d;
      padding: 1.5rem;
      border-radius: 8px;
      max-width: 500px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    .modal-header h3 {
      font-size: 1.3rem;
    }
    .close-modal {
      background: none;
      color: #ccc;
      font-size: 2rem;
      padding: 0;
      width: 2rem;
      height: 2rem;
      line-height: 1;
    }
    .version {
      text-align: center;
      font-size: 0.75rem;
      color: #666;
      padding: 0.5rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>üìΩÔ∏è Slideshow Editor</h2>
    
    <!-- Slideshow Sets Selection -->
    <div class="sets-panel">
      <div class="sets-tabs" id="setsTabs">
        <!-- Populated dynamically -->
      </div>
      <div class="set-controls">
        <button onclick="createNewSet()">+ New Set</button>
        <button class="secondary" onclick="renameSet()">‚úèÔ∏è Rename</button>
        <button class="danger" onclick="deleteSet()">üóëÔ∏è Delete Set</button>
      </div>
    </div>

    <!-- Slides List -->
    <div class="slides-list">
      <h3 style="margin-bottom: 0.75rem;">Slides</h3>
      <div id="slidesList">
        <p style="color: #666; text-align: center;">No slides yet</p>
      </div>
      <button onclick="addSlide()" style="width: 100%; margin-top: 0.5rem;">+ Add Slide</button>
    </div>

    <!-- View Tabs -->
    <div class="view-tabs">
      <button class="view-tab active" onclick="switchView('editor')">‚úèÔ∏è Editor</button>
      <button class="view-tab" onclick="switchView('preview')">üëÅÔ∏è Preview</button>
    </div>

    <!-- WYSIWYG Slide Editor -->
    <div class="wysiwyg-editor" id="wysiwygEditor" style="display: none;">
      <!-- Slide Thumbnails -->
      <div class="slide-thumbnails" id="slideThumbnails">
        <!-- Populated dynamically -->
      </div>

      <!-- Canvas and Properties -->
      <div style="display: flex; gap: 1rem; flex: 1;">
        <!-- Canvas Container -->
        <div style="flex: 1;">
          <!-- Toolbar -->
          <div class="toolbar">
            <button class="tool-btn" id="addTextBtn" onclick="addTextElement()">üìù Text</button>
            <button class="tool-btn" id="addImageBtn" onclick="addImageElement()">üñºÔ∏è Image</button>
            <button class="tool-btn" id="addShapeBtn" onclick="addShapeElement()">‚¨ú Shape</button>
            <button class="tool-btn" id="addLmsBtn" onclick="addLmsElement()">üìÑ LMS</button>
            <button class="tool-btn" onclick="undoAction()">‚Ü∂ Undo</button>
            <button class="tool-btn" onclick="redoAction()">‚Ü∑ Redo</button>
            <button class="tool-btn" onclick="duplicateSlide()">üìã Duplicate</button>
          </div>

          <!-- Canvas -->
          <div class="canvas-container" id="canvasContainer" onclick="deselectElements(event)">
            <div class="canvas-background" id="canvasBackground"></div>
            <div class="element-selector" id="elementSelector">Click element to edit</div>
            <!-- Canvas elements will be added here dynamically -->
          </div>
        </div>

        <!-- Properties Panel -->
        <div class="properties-panel" id="propertiesPanel">
          <h4>Slide Properties</h4>

          <div class="property-group">
            <label>Duration (seconds)</label>
            <input type="number" id="slideDurationProp" min="1" max="300" step="0.5">
          </div>

          <div class="property-group">
            <label>Transition</label>
            <select id="slideTransitionProp">
              <option value="fade">Fade</option>
              <option value="slide-left">Slide Left</option>
              <option value="slide-right">Slide Right</option>
              <option value="slide-up">Slide Up</option>
              <option value="slide-down">Slide Down</option>
              <option value="slide-top-left">Slide Top-Left</option>
              <option value="slide-top-right">Slide Top-Right</option>
              <option value="slide-bottom-left">Slide Bottom-Left</option>
              <option value="slide-bottom-right">Slide Bottom-Right</option>
              <option value="zoom">Zoom In</option>
              <option value="zoom-out">Zoom Out</option>
              <option value="rotate">Rotate</option>
              <option value="flip-horizontal">Flip Horizontal</option>
              <option value="flip-vertical">Flip Vertical</option>
              <option value="scale">Scale</option>
              <option value="bounce">Bounce</option>
              <option value="elastic">Elastic</option>
              <option value="none">None</option>
            </select>
          </div>

          <div class="property-group">
            <label>Transition Duration (ms)</label>
            <input type="number" id="transitionDurationProp" min="100" max="5000" step="100" value="1000">
          </div>

          <div class="property-group">
            <label>Easing</label>
            <select id="transitionEasingProp">
              <option value="linear">Linear</option>
              <option value="ease-in">Ease In</option>
              <option value="ease-out">Ease Out</option>
              <option value="ease-in-out">Ease In-Out</option>
              <option value="bounce">Bounce</option>
              <option value="elastic">Elastic</option>
            </select>
          </div>

          <div class="property-group">
            <label>Background</label>
            <input type="text" id="slideBackgroundProp" placeholder="../bg/image.jpg">
            <input type="file" id="bgUpload" accept="image/*" onchange="uploadBackground(this)" style="margin-top: 0.5rem; font-size: 0.8rem;">
          </div>

          <h4 style="margin-top: 1.5rem;">Element Properties</h4>
          <div id="elementProperties">
            <p style="color: #666; font-size: 0.9rem;">Select an element to edit properties</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Legacy Form Editor (fallback) -->
    <div class="editor-panel" id="editorPanel">
      <h3>Slide Editor</h3>
      <p style="color: #666;">Select a slide to edit</p>
    </div>

    <!-- Preview -->
    <div class="preview-panel" id="previewPanel" style="display: none;">
      <div class="preview-content" id="previewContent">
        <p style="color: #666;">Preview will appear here</p>
      </div>
    </div>

    <div style="display: flex; gap: 0.5rem; flex-shrink: 0;">
      <button onclick="saveSet()" style="flex: 1;">üíæ Save Slideshow</button>
      <button class="secondary" onclick="testSlideshow()" style="flex: 1;">‚ñ∂Ô∏è Test</button>
    </div>
  </div>

  <div id="toast" class="toast" style="display: none;" aria-live="polite" role="status"></div>

  <!-- New Set Modal -->
  <div id="newSetModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>New Slideshow Set</h3>
        <button class="close-modal" onclick="closeModal('newSetModal')">√ó</button>
      </div>
      <div class="form-group">
        <label>Set Name</label>
        <input type="text" id="newSetName" placeholder="e.g., upcoming-events">
      </div>
      <div class="form-group">
        <label>Description</label>
        <input type="text" id="newSetDesc" placeholder="Optional description">
      </div>
      <button onclick="createSet()" style="width: 100%; margin-top: 1rem;">Create</button>
    </div>
  </div>

  <div class="version">314Sign v1.0.2.32 | ¬© 2025 J Stekervetz | CC BY-NC 4.0</div>

  <script>
    let currentSet = null;
    let currentSlideIndex = null;
    let slideData = {
      name: "",
      description: "",
      defaultDuration: 5000,
      defaultTransition: "fade",
      slides: []
    };

    // Load available sets on startup
    function loadSets() {
      fetch('sets/index.php')
        .then(r => r.json())
        .then(files => {
          if (files.length === 0) {
            // No sets found, show example
            files.push('example.json');
          }
          
          const tabsContainer = document.getElementById('setsTabs');
          tabsContainer.innerHTML = '';
          
          files.forEach((file, index) => {
            const button = document.createElement('button');
            button.className = 'set-tab' + (index === 0 ? ' active' : '');
            button.textContent = file.replace('.json', '');
            button.onclick = () => loadSet(file);
            tabsContainer.appendChild(button);
            
            if (index === 0) {
              currentSet = file;
              loadSet(file);
            }
          });
        })
        .catch(() => {
          showToast('Failed to load sets', 2000);
        });
    }

    // Load a specific set
    function loadSet(filename) {
      currentSet = filename;
      
      // Update active tab
      document.querySelectorAll('.set-tab').forEach(tab => {
        tab.classList.toggle('active', tab.textContent === filename.replace('.json', ''));
      });
      
      fetch('sets/' + filename)
        .then(r => r.ok ? r.json() : null)
        .then(data => {
          if (data) {
            slideData = data;
            renderSlidesList();
            currentSlideIndex = null;
            showEmptyEditor();
          }
        })
        .catch(() => {
          showToast('Failed to load set', 2000);
        });
    }

    // Render slides list
    function renderSlidesList() {
      const container = document.getElementById('slidesList');
      
      if (slideData.slides.length === 0) {
        container.innerHTML = '<p style="color: #666; text-align: center;">No slides yet</p>';
        return;
      }
      
      container.innerHTML = slideData.slides.map((slide, index) => `
        <div class="slide-item ${index === currentSlideIndex ? 'active' : ''}" onclick="editSlide(${index})">
          <div class="slide-info">
            <span class="slide-type">${slide.type.toUpperCase()}</span>
            <span>${slide.type === 'text' ? (slide.content?.substring(0, 30) || 'Empty') : slide.media || 'No media'}</span>
          </div>
          <div class="slide-actions">
            <button onclick="moveSlide(${index}, -1); event.stopPropagation();" ${index === 0 ? 'disabled' : ''}>‚Üë</button>
            <button onclick="moveSlide(${index}, 1); event.stopPropagation();" ${index === slideData.slides.length - 1 ? 'disabled' : ''}>‚Üì</button>
            <button class="danger" onclick="deleteSlide(${index}); event.stopPropagation();">√ó</button>
          </div>
        </div>
      `).join('');
    }

    // Add new slide
    function addSlide() {
      const newSlide = {
        type: 'text',
        duration: slideData.defaultDuration || 5000,
        transition: slideData.defaultTransition || 'fade',
        background: '',
        content: '',
        font: 'Lato, sans-serif',
        fontSize: 5
      };
      
      slideData.slides.push(newSlide);
      renderSlidesList();
      editSlide(slideData.slides.length - 1);
    }

    // Edit slide
    function editSlide(index) {
      currentSlideIndex = index;
      renderSlidesList();
      
      const slide = slideData.slides[index];
      const panel = document.getElementById('editorPanel');
      
      panel.innerHTML = `
        <h3>Edit Slide #${index + 1}</h3>
        
        <div class="form-group">
          <label>Slide Type</label>
          <select id="slideType" onchange="updateSlideType()">
            <option value="text" ${slide.type === 'text' ? 'selected' : ''}>Text with Background</option>
            <option value="image" ${slide.type === 'image' ? 'selected' : ''}>Image</option>
            <option value="video" ${slide.type === 'video' ? 'selected' : ''}>Video</option>
          </select>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>Duration (ms)</label>
            <input type="number" id="slideDuration" value="${slide.duration}" min="0" step="1000">
            <small style="color: #888; font-size: 0.8rem;">0 = video length</small>
          </div>
          <div class="form-group">
            <label>Transition</label>
            <select id="slideTransition">
              <option value="fade" ${slide.transition === 'fade' ? 'selected' : ''}>Fade</option>
              <option value="slide-left" ${slide.transition === 'slide-left' ? 'selected' : ''}>Slide Left</option>
              <option value="slide-right" ${slide.transition === 'slide-right' ? 'selected' : ''}>Slide Right</option>
              <option value="slide-up" ${slide.transition === 'slide-up' ? 'selected' : ''}>Slide Up</option>
              <option value="slide-down" ${slide.transition === 'slide-down' ? 'selected' : ''}>Slide Down</option>
              <option value="zoom" ${slide.transition === 'zoom' ? 'selected' : ''}>Zoom</option>
              <option value="none" ${slide.transition === 'none' ? 'selected' : ''}>None</option>
            </select>
          </div>
        </div>
        
        <div id="typeSpecificFields"></div>
        
        <button onclick="updateSlide()" style="width: 100%;">Update Slide</button>
      `;
      
      updateSlideTypeFields();
      updatePreview();
    }

    // Update slide type fields
    function updateSlideType() {
      const type = document.getElementById('slideType').value;
      slideData.slides[currentSlideIndex].type = type;
      updateSlideTypeFields();
    }

    function updateSlideTypeFields() {
      const slide = slideData.slides[currentSlideIndex];
      const container = document.getElementById('typeSpecificFields');
      
      if (slide.type === 'text') {
        container.innerHTML = `
          <div class="form-group">
            <label>Background Image</label>
            <input type="text" id="slideBackground" value="${slide.background || ''}" placeholder="../bg/image.jpg">
          </div>
          <div class="form-group">
            <label>Content (Markdown supported)</label>
            <textarea id="slideContent" oninput="updatePreview()">${slide.content || ''}</textarea>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Font</label>
              <input type="text" id="slideFont" value="${slide.font || 'Lato, sans-serif'}">
            </div>
            <div class="form-group">
              <label>Font Size (%)</label>
              <input type="number" id="slideFontSize" value="${slide.fontSize || 5}" min="1" max="20" step="0.5">
            </div>
          </div>
        `;
      } else if (slide.type === 'image') {
        container.innerHTML = `
          <div class="form-group">
            <label>Image Path</label>
            <input type="text" id="slideMedia" value="${slide.media || ''}" placeholder="media/image.jpg">
          </div>
          <div class="form-group">
            <label>Upload Image</label>
            <input type="file" id="mediaUpload" accept="image/*" onchange="uploadMedia(this)">
          </div>
          <div class="form-group">
            <label>Caption (optional)</label>
            <input type="text" id="slideCaption" value="${slide.caption || ''}">
          </div>
          <div class="form-group">
            <label>Caption Position</label>
            <select id="slideCaptionPos">
              <option value="top" ${slide.captionPosition === 'top' ? 'selected' : ''}>Top</option>
              <option value="bottom" ${slide.captionPosition === 'bottom' ? 'selected' : ''}>Bottom</option>
              <option value="center" ${slide.captionPosition === 'center' ? 'selected' : ''}>Center</option>
            </select>
          </div>
        `;
      } else if (slide.type === 'video') {
        container.innerHTML = `
          <div class="form-group">
            <label>Video Path</label>
            <input type="text" id="slideMedia" value="${slide.media || ''}" placeholder="media/video.mp4">
          </div>
          <div class="form-group">
            <label>Upload Video</label>
            <input type="file" id="mediaUpload" accept="video/*" onchange="uploadMedia(this)">
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>
                <input type="checkbox" id="slideLoop" ${slide.loop ? 'checked' : ''}>
                Loop video
              </label>
            </div>
            <div class="form-group">
              <label>
                <input type="checkbox" id="slideMuted" ${slide.muted ? 'checked' : ''}>
                Muted
              </label>
            </div>
          </div>
        `;
      }
    }

    // Update slide with current form values
    function updateSlide() {
      const slide = slideData.slides[currentSlideIndex];
      
      slide.duration = parseInt(document.getElementById('slideDuration').value);
      slide.transition = document.getElementById('slideTransition').value;
      
      if (slide.type === 'text') {
        slide.background = document.getElementById('slideBackground').value;
        slide.content = document.getElementById('slideContent').value;
        slide.font = document.getElementById('slideFont').value;
        slide.fontSize = parseFloat(document.getElementById('slideFontSize').value);
      } else if (slide.type === 'image') {
        slide.media = document.getElementById('slideMedia').value;
        slide.caption = document.getElementById('slideCaption').value;
        slide.captionPosition = document.getElementById('slideCaptionPos').value;
      } else if (slide.type === 'video') {
        slide.media = document.getElementById('slideMedia').value;
        slide.loop = document.getElementById('slideLoop').checked;
        slide.muted = document.getElementById('slideMuted').checked;
      }
      
      renderSlidesList();
      updatePreview();
      showToast('Slide updated');
    }

    // Update preview
    function updatePreview() {
      if (currentSlideIndex === null) return;
      
      const slide = slideData.slides[currentSlideIndex];
      const preview = document.getElementById('previewContent');
      
      if (slide.type === 'text') {
        const content = document.getElementById('slideContent')?.value || slide.content || '';
        const bgStyle = slide.background ? `background-image: url('${slide.background}'); background-size: cover; background-position: center;` : 'background: #000;';
        
        // Process markdown and color tags
        let html = marked.parse(content);
        
        preview.innerHTML = `
          <div style="${bgStyle} width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; padding: 2rem;">
            <div style="font-family: ${slide.font}; font-size: ${slide.fontSize}vw; color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.8);">
              ${html}
            </div>
          </div>
        `;
      } else if (slide.type === 'image') {
        const caption = slide.caption ? `<div style="position: absolute; ${slide.captionPosition === 'top' ? 'top' : 'bottom'}: 0; width: 100%; background: rgba(0,0,0,0.7); color: white; padding: 1rem; text-align: center; font-size: 1.5rem;">${slide.caption}</div>` : '';
        preview.innerHTML = `
          <div style="position: relative; width: 100%; height: 100%;">
            <img src="${slide.media}" alt="Slide" style="width: 100%; height: 100%; object-fit: contain;">
            ${caption}
          </div>
        `;
      } else if (slide.type === 'video') {
        preview.innerHTML = `
          <video src="${slide.media}" ${slide.loop ? 'loop' : ''} ${slide.muted ? 'muted' : ''} controls style="max-width: 100%; max-height: 100%;">
          </video>
        `;
      }
    }

    // Move slide
    function moveSlide(index, direction) {
      if (index + direction < 0 || index + direction >= slideData.slides.length) return;
      
      const temp = slideData.slides[index];
      slideData.slides[index] = slideData.slides[index + direction];
      slideData.slides[index + direction] = temp;
      
      if (currentSlideIndex === index) {
        currentSlideIndex = index + direction;
      } else if (currentSlideIndex === index + direction) {
        currentSlideIndex = index;
      }
      
      renderSlidesList();
      if (currentSlideIndex !== null) {
        editSlide(currentSlideIndex);
      }
    }

    // Delete slide
    function deleteSlide(index) {
      if (!confirm('Delete this slide?')) return;
      
      slideData.slides.splice(index, 1);
      renderSlidesList();
      
      if (currentSlideIndex === index) {
        currentSlideIndex = null;
        showEmptyEditor();
      } else if (currentSlideIndex > index) {
        currentSlideIndex--;
      }
    }

    // Show empty editor state
    function showEmptyEditor() {
      const panel = document.getElementById('editorPanel');
      panel.innerHTML = `
        <h3>Slide Editor</h3>
        <p style="color: #666;">Select a slide to edit or add a new one</p>
      `;
      
      const preview = document.getElementById('previewContent');
      preview.innerHTML = '<p style="color: #666;">Preview will appear here</p>';
    }

    // Save set (server-backed)
    function saveSet() {
      if (!currentSet) {
        showToast('No set selected', 2000);
        return;
      }

      fetch('save-set.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ filename: 'sets/' + currentSet, content: slideData })
      })
      .then(r => r.json())
      .then(data => {
        if (data && data.success) {
          showToast('Slideshow saved!');
        } else {
          throw new Error((data && data.error) || 'Save failed');
        }
      })
      .catch(err => {
        console.error('Save failed:', err);
        showToast('Failed to save', 2000);
      });
    }

    // Upload media
    function uploadMedia(input) {
      if (!input.files || !input.files[0]) return;
      
      const file = input.files[0];
      const formData = new FormData();
      formData.append('file', file);
      
      showToast('Uploading...', 1000);
      
      fetch('upload-media.php', {
        method: 'POST',
        body: formData
      })
      .then(r => r.json())
      .then(data => {
        if (data.filename) {
          document.getElementById('slideMedia').value = 'media/' + data.filename;
          showToast('Upload complete!');
          updateSlide();
        } else {
          throw new Error(data.error || 'Upload failed');
        }
      })
      .catch(err => {
        showToast('Upload failed: ' + err.message, 3000);
      });
    }

    // Create new set
    function createNewSet() {
      document.getElementById('newSetModal').classList.add('active');
      document.getElementById('newSetName').value = '';
      document.getElementById('newSetDesc').value = '';
    }

    function createSet() {
      const name = document.getElementById('newSetName').value.trim();
      if (!name) {
        showToast('Enter a set name', 2000);
        return;
      }
      
      const filename = name.toLowerCase().replace(/[^a-z0-9-]/g, '-') + '.json';
      const newSet = {
        name: name,
        description: document.getElementById('newSetDesc').value,
        defaultDuration: 5000,
        defaultTransition: 'fade',
        slides: []
      };
      
      fetch('save-set.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ filename: 'sets/' + filename, content: newSet })
      })
      .then(r => r.json())
      .then(data => {
        if (data && data.success) {
          closeModal('newSetModal');
          showToast('Set created!');
          loadSets();
        } else {
          throw new Error((data && data.error) || 'Create failed');
        }
      })
      .catch(() => {
        showToast('Failed to create set', 2000);
      });
    }

    // Rename set
    function renameSet() {
      if (!currentSet) return;
      
      const newName = prompt('Enter new name:', currentSet.replace('.json', ''));
      if (!newName) return;
      
      const newFilename = newName.toLowerCase().replace(/[^a-z0-9-]/g, '-') + '.json';
      
      // Save to new filename (server-backed). Note: old file is not deleted automatically.
      fetch('save-set.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ filename: 'sets/' + newFilename, content: slideData })
      })
      .then(r => r.json())
      .then(data => {
        if (data && data.success) {
          currentSet = newFilename;
          showToast('Set renamed!');
          loadSets();
        } else {
          throw new Error((data && data.error) || 'Rename failed');
        }
      })
      .catch(() => {
        showToast('Failed to rename', 2000);
      });
    }

    // Delete set
    function deleteSet() {
      if (!currentSet) return;
      if (!confirm('Delete this slideshow set? This cannot be undone.')) return;
      
      // Would need PHP backend to actually delete
      showToast('Delete requires server-side implementation', 3000);
    }

    // Test slideshow
    function testSlideshow() {
      if (!currentSet) return;
      
      window.open('../?slideshow=slideshows/sets/' + currentSet, '_blank');
    }

    // Close modal
    function closeModal(id) {
      document.getElementById(id).classList.remove('active');
    }

    // Toast helper
    let toastTimer = null;
    function showToast(msg, ms = 3000) {
      const el = document.getElementById('toast');
      el.textContent = msg;
      el.style.display = 'block';
      if (toastTimer) clearTimeout(toastTimer);
      toastTimer = setTimeout(() => {
        el.style.display = 'none';
      }, ms);
    }

    // WYSIWYG Editor Variables
    let selectedElement = null;
    let isDragging = false;
    let isResizing = false;
    let dragOffset = { x: 0, y: 0 };
    let resizeHandle = null;
    let elementCounter = 0;
    let undoStack = [];
    let redoStack = [];

    // Switch between editor and preview views
    function switchView(view) {
      const wysiwygEditor = document.getElementById('wysiwygEditor');
      const editorPanel = document.getElementById('editorPanel');
      const previewPanel = document.getElementById('previewPanel');
      const editorTab = document.querySelector('.view-tab:first-child');
      const previewTab = document.querySelector('.view-tab:last-child');

      if (view === 'editor') {
        if (currentSlideIndex !== null) {
          loadWYSIWYGEditor();
          wysiwygEditor.style.display = 'flex';
          editorPanel.style.display = 'none';
        } else {
          wysiwygEditor.style.display = 'none';
          editorPanel.style.display = 'block';
          showEmptyEditor();
        }
        previewPanel.style.display = 'none';
        editorTab.classList.add('active');
        previewTab.classList.remove('active');
      } else if (view === 'preview') {
        wysiwygEditor.style.display = 'none';
        editorPanel.style.display = 'none';
        previewPanel.style.display = 'block';
        editorTab.classList.remove('active');
        previewTab.classList.add('active');
        // Update preview when switching to preview mode
        if (currentSlideIndex !== null) {
          updatePreview();
        }
      }
    }

    // Load WYSIWYG Editor for current slide
    function loadWYSIWYGEditor() {
      if (currentSlideIndex === null) return;

      const slide = slideData.slides[currentSlideIndex];
      renderSlideThumbnails();
      loadCanvasElements(slide);
      updateSlideProperties();

      // Set background
      const canvasBg = document.getElementById('canvasBackground');
      if (slide.background) {
        canvasBg.style.backgroundImage = `url('${slide.background}')`;
        canvasBg.style.opacity = '1';
      } else {
        canvasBg.style.backgroundImage = 'none';
        canvasBg.style.backgroundColor = '#000';
      }
    }

    // Render slide thumbnails
    function renderSlideThumbnails() {
      const container = document.getElementById('slideThumbnails');
      container.innerHTML = '';

      slideData.slides.forEach((slide, index) => {
        const thumbnail = document.createElement('div');
        thumbnail.className = `slide-thumbnail ${index === currentSlideIndex ? 'active' : ''}`;
        thumbnail.onclick = () => selectSlide(index);
        thumbnail.innerHTML = `
          <div class="slide-number">${index + 1}</div>
          <div class="slide-type">${slide.type?.toUpperCase() || 'TXT'}</div>
        `;

        // Add drag and drop for reordering
        thumbnail.draggable = true;
        thumbnail.ondragstart = (e) => startDrag(e, index);
        thumbnail.ondragover = (e) => allowDrop(e);
        thumbnail.ondrop = (e) => dropSlide(e, index);

        container.appendChild(thumbnail);
      });
    }

    // Select a slide
    function selectSlide(index) {
      saveCurrentCanvasState();
      currentSlideIndex = index;
      renderSlideThumbnails();
      loadWYSIWYGEditor();
    }

    // Drag and drop for slide reordering
    function startDrag(e, index) {
      e.dataTransfer.setData('text/plain', index);
    }

    function allowDrop(e) {
      e.preventDefault();
      e.currentTarget.classList.add('drag-over');
    }

    function dropSlide(e, targetIndex) {
      e.preventDefault();
      e.currentTarget.classList.remove('drag-over');

      const sourceIndex = parseInt(e.dataTransfer.getData('text/plain'));
      if (sourceIndex === targetIndex) return;

      // Reorder slides
      const [removed] = slideData.slides.splice(sourceIndex, 1);
      slideData.slides.splice(targetIndex, 0, removed);

      // Update current slide index
      if (sourceIndex === currentSlideIndex) {
        currentSlideIndex = targetIndex;
      } else if (sourceIndex < currentSlideIndex && targetIndex >= currentSlideIndex) {
        currentSlideIndex--;
      } else if (sourceIndex > currentSlideIndex && targetIndex <= currentSlideIndex) {
        currentSlideIndex++;
      }

      renderSlideThumbnails();
      renderSlidesList();
      loadWYSIWYGEditor();
    }

    // Load canvas elements for current slide
    function loadCanvasElements(slide) {
      const canvas = document.getElementById('canvasContainer');
      const elements = canvas.querySelectorAll('.canvas-element:not(#canvasBackground):not(#elementSelector)');
      elements.forEach(el => el.remove());

      // Initialize elements array if it doesn't exist
      if (!slide.elements) {
        slide.elements = [];
      }

      slide.elements.forEach((element, index) => {
        createCanvasElement(element, index);
      });
    }

    // Create canvas element
    function createCanvasElement(elementData, index) {
      const canvas = document.getElementById('canvasContainer');
      const element = document.createElement('div');

      element.className = `canvas-element ${elementData.type}-element`;
      element.dataset.index = index;
      element.style.left = elementData.x + 'px';
      element.style.top = elementData.y + 'px';
      element.style.width = elementData.width + 'px';
      element.style.height = elementData.height + 'px';

      // Add resize handles
      ['nw', 'ne', 'sw', 'se'].forEach(handle => {
        const resizeHandle = document.createElement('div');
        resizeHandle.className = `resize-handle ${handle}`;
        resizeHandle.onmousedown = (e) => startResize(e, element, handle);
        element.appendChild(resizeHandle);
      });

      // Element content
      if (elementData.type === 'text') {
        element.textContent = elementData.content || 'Sample Text';
        element.style.fontSize = elementData.fontSize || '24px';
        element.style.fontFamily = elementData.fontFamily || 'Arial';
        element.style.color = elementData.color || '#ffffff';
        element.style.textAlign = elementData.textAlign || 'center';
      } else if (elementData.type === 'image') {
        const img = document.createElement('img');
        img.src = elementData.src || '';
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.objectFit = 'contain';
        element.appendChild(img);
      } else if (elementData.type === 'shape') {
        element.style.backgroundColor = elementData.fillColor || '#4a9eff';
        element.style.border = `2px solid ${elementData.strokeColor || '#ffffff'}`;
      }

      // Event handlers
      element.onclick = (e) => selectElement(e, element);
      element.onmousedown = (e) => startDragElement(e, element);

      canvas.appendChild(element);
      return element;
    }

    // Add text element
    function addTextElement() {
      const newElement = {
        type: 'text',
        content: 'New Text',
        x: 100,
        y: 100,
        width: 200,
        height: 50,
        fontSize: '24px',
        fontFamily: 'Arial',
        color: '#ffffff',
        textAlign: 'center'
      };

      const slide = slideData.slides[currentSlideIndex];
      if (!slide.elements) slide.elements = [];
      slide.elements.push(newElement);

      createCanvasElement(newElement, slide.elements.length - 1);
      saveCanvasState();
    }

    // Add image element
    function addImageElement() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
          uploadAndAddImage(file);
        }
      };
      input.click();
    }

    // Upload and add image
    function uploadAndAddImage(file) {
      const formData = new FormData();
      formData.append('file', file);

      fetch('upload-media.php', {
        method: 'POST',
        body: formData
      })
      .then(r => r.json())
      .then(data => {
        if (data.filename) {
          const newElement = {
            type: 'image',
            src: 'media/' + data.filename,
            x: 50,
            y: 50,
            width: 200,
            height: 150
          };

          const slide = slideData.slides[currentSlideIndex];
          if (!slide.elements) slide.elements = [];
          slide.elements.push(newElement);

          createCanvasElement(newElement, slide.elements.length - 1);
          saveCanvasState();
        }
      })
      .catch(err => {
        showToast('Failed to upload image', 3000);
      });
    }

    // Add shape element
    function addShapeElement() {
      const newElement = {
        type: 'shape',
        x: 150,
        y: 150,
        width: 100,
        height: 100,
        fillColor: '#4a9eff',
        strokeColor: '#ffffff'
      };

      const slide = slideData.slides[currentSlideIndex];
      if (!slide.elements) slide.elements = [];
      slide.elements.push(newElement);

      createCanvasElement(newElement, slide.elements.length - 1);
      saveCanvasState();
    }

    // Add LMS element (placeholder)
    function addLmsElement() {
      showToast('LMS integration coming soon!', 2000);
    }

    // Select element
    function selectElement(e, element) {
      e.stopPropagation();
      deselectElements();

      selectedElement = element;
      element.classList.add('selected');

      const index = parseInt(element.dataset.index);
      const slide = slideData.slides[currentSlideIndex];
      const elementData = slide.elements[index];

      showElementProperties(elementData, index);
    }

    // Deselect elements
    function deselectElements() {
      document.querySelectorAll('.canvas-element.selected').forEach(el => {
        el.classList.remove('selected');
      });
      selectedElement = null;
      document.getElementById('elementProperties').innerHTML =
        '<p style="color: #666; font-size: 0.9rem;">Select an element to edit properties</p>';
    }

    // Start dragging element
    function startDragElement(e, element) {
      if (e.target.classList.contains('resize-handle')) return;

      e.preventDefault();
      isDragging = true;
      selectedElement = element;

      const rect = element.getBoundingClientRect();
      dragOffset.x = e.clientX - rect.left;
      dragOffset.y = e.clientY - rect.top;

      document.addEventListener('mousemove', dragElement);
      document.addEventListener('mouseup', stopDragElement);
    }

    // Drag element
    function dragElement(e) {
      if (!isDragging || !selectedElement) return;

      const canvas = document.getElementById('canvasContainer');
      const canvasRect = canvas.getBoundingClientRect();

      let newX = e.clientX - canvasRect.left - dragOffset.x;
      let newY = e.clientY - canvasRect.top - dragOffset.y;

      // Constrain to canvas bounds
      const maxX = canvasRect.width - selectedElement.offsetWidth;
      const maxY = canvasRect.height - selectedElement.offsetHeight;
      newX = Math.max(0, Math.min(newX, maxX));
      newY = Math.max(0, Math.min(newY, maxY));

      selectedElement.style.left = newX + 'px';
      selectedElement.style.top = newY + 'px';

      updateElementData(selectedElement, { x: newX, y: newY });
    }

    // Stop dragging
    function stopDragElement() {
      if (isDragging) {
        saveCanvasState();
        isDragging = false;
      }
      document.removeEventListener('mousemove', dragElement);
      document.removeEventListener('mouseup', stopDragElement);
    }

    // Start resizing
    function startResize(e, element, handle) {
      e.preventDefault();
      e.stopPropagation();

      isResizing = true;
      selectedElement = element;
      resizeHandle = handle;

      document.addEventListener('mousemove', resizeElement);
      document.addEventListener('mouseup', stopResize);
    }

    // Resize element
    function resizeElement(e) {
      if (!isResizing || !selectedElement) return;

      const rect = selectedElement.getBoundingClientRect();
      const canvas = document.getElementById('canvasContainer');
      const canvasRect = canvas.getBoundingClientRect();

      let newWidth = rect.width;
      let newHeight = rect.height;
      let newX = parseFloat(selectedElement.style.left);
      let newY = parseFloat(selectedElement.style.top);

      if (resizeHandle.includes('e')) {
        newWidth = Math.max(50, e.clientX - canvasRect.left - newX);
      }
      if (resizeHandle.includes('s')) {
        newHeight = Math.max(30, e.clientY - canvasRect.top - newY);
      }
      if (resizeHandle.includes('w')) {
        const deltaX = rect.left - (e.clientX - canvasRect.left);
        newWidth = Math.max(50, rect.width + deltaX);
        newX = Math.max(0, newX - deltaX);
      }
      if (resizeHandle.includes('n')) {
        const deltaY = rect.top - (e.clientY - canvasRect.top);
        newHeight = Math.max(30, rect.height + deltaY);
        newY = Math.max(0, newY - deltaY);
      }

      selectedElement.style.width = newWidth + 'px';
      selectedElement.style.height = newHeight + 'px';
      selectedElement.style.left = newX + 'px';
      selectedElement.style.top = newY + 'px';

      updateElementData(selectedElement, {
        x: newX,
        y: newY,
        width: newWidth,
        height: newHeight
      });
    }

    // Stop resizing
    function stopResize() {
      if (isResizing) {
        saveCanvasState();
        isResizing = false;
        resizeHandle = null;
      }
      document.removeEventListener('mousemove', resizeElement);
      document.removeEventListener('mouseup', stopResize);
    }

    // Update element data
    function updateElementData(element, updates) {
      const index = parseInt(element.dataset.index);
      const slide = slideData.slides[currentSlideIndex];
      if (slide.elements && slide.elements[index]) {
        Object.assign(slide.elements[index], updates);
      }
    }

    // Show element properties
    function showElementProperties(elementData, index) {
      const container = document.getElementById('elementProperties');

      if (elementData.type === 'text') {
        container.innerHTML = `
          <div class="property-group">
            <label>Content</label>
            <textarea id="textContent" onchange="updateTextProperty('content', this.value, ${index})">${elementData.content || ''}</textarea>
          </div>
          <div class="property-row">
            <div class="property-group">
              <label>Font Size</label>
              <input type="number" id="fontSize" value="${parseInt(elementData.fontSize) || 24}" min="8" max="100"
                     onchange="updateTextProperty('fontSize', this.value + 'px', ${index})">
            </div>
            <div class="property-group">
              <label>Color</label>
              <input type="color" id="textColor" value="${elementData.color || '#ffffff'}"
                     onchange="updateTextProperty('color', this.value, ${index})">
            </div>
          </div>
          <div class="property-group">
            <label>Font Family</label>
            <select id="fontFamily" onchange="updateTextProperty('fontFamily', this.value, ${index})">
              <option value="Arial" ${elementData.fontFamily === 'Arial' ? 'selected' : ''}>Arial</option>
              <option value="Helvetica" ${elementData.fontFamily === 'Helvetica' ? 'selected' : ''}>Helvetica</option>
              <option value="Times New Roman" ${elementData.fontFamily === 'Times New Roman' ? 'selected' : ''}>Times New Roman</option>
              <option value="Courier New" ${elementData.fontFamily === 'Courier New' ? 'selected' : ''}>Courier New</option>
            </select>
          </div>
          <button class="delete-btn" onclick="deleteElement(${index})">Delete Element</button>
        `;
      } else if (elementData.type === 'image') {
        container.innerHTML = `
          <div class="property-group">
            <label>Image Source</label>
            <input type="text" id="imageSrc" value="${elementData.src || ''}"
                   onchange="updateImageProperty('src', this.value, ${index})">
          </div>
          <button class="delete-btn" onclick="deleteElement(${index})">Delete Element</button>
        `;
      } else if (elementData.type === 'shape') {
        container.innerHTML = `
          <div class="property-row">
            <div class="property-group">
              <label>Fill Color</label>
              <input type="color" id="fillColor" value="${elementData.fillColor || '#4a9eff'}"
                     onchange="updateShapeProperty('fillColor', this.value, ${index})">
            </div>
            <div class="property-group">
              <label>Stroke Color</label>
              <input type="color" id="strokeColor" value="${elementData.strokeColor || '#ffffff'}"
                     onchange="updateShapeProperty('strokeColor', this.value, ${index})">
            </div>
          </div>
          <button class="delete-btn" onclick="deleteElement(${index})">Delete Element</button>
        `;
      }
    }

    // Update text property
    function updateTextProperty(property, value, index) {
      const slide = slideData.slides[currentSlideIndex];
      if (slide.elements && slide.elements[index]) {
        slide.elements[index][property] = value;

        // Update visual element
        const element = document.querySelector(`.canvas-element[data-index="${index}"]`);
        if (element) {
          if (property === 'content') {
            element.textContent = value;
          } else if (property === 'fontSize') {
            element.style.fontSize = value;
          } else if (property === 'color') {
            element.style.color = value;
          } else if (property === 'fontFamily') {
            element.style.fontFamily = value;
          }
        }
        saveCanvasState();
      }
    }

    // Update image property
    function updateImageProperty(property, value, index) {
      const slide = slideData.slides[currentSlideIndex];
      if (slide.elements && slide.elements[index]) {
        slide.elements[index][property] = value;

        // Update visual element
        const element = document.querySelector(`.canvas-element[data-index="${index}"] img`);
        if (element) {
          element.src = value;
        }
        saveCanvasState();
      }
    }

    // Update shape property
    function updateShapeProperty(property, value, index) {
      const slide = slideData.slides[currentSlideIndex];
      if (slide.elements && slide.elements[index]) {
        slide.elements[index][property] = value;

        // Update visual element
        const element = document.querySelector(`.canvas-element[data-index="${index}"]`);
        if (element) {
          if (property === 'fillColor') {
            element.style.backgroundColor = value;
          } else if (property === 'strokeColor') {
            element.style.borderColor = value;
          }
        }
        saveCanvasState();
      }
    }

    // Delete element
    function deleteElement(index) {
      if (!confirm('Delete this element?')) return;

      const slide = slideData.slides[currentSlideIndex];
      if (slide.elements) {
        slide.elements.splice(index, 1);

        // Remove from canvas
        const element = document.querySelector(`.canvas-element[data-index="${index}"]`);
        if (element) {
          element.remove();
        }

        // Update remaining elements' data-index
        document.querySelectorAll('.canvas-element').forEach((el, i) => {
          el.dataset.index = i;
        });

        deselectElements();
        saveCanvasState();
      }
    }

    // Update slide properties
    function updateSlideProperties() {
      const slide = slideData.slides[currentSlideIndex];
      if (!slide) return;

      document.getElementById('slideDurationProp').value = slide.duration / 1000 || 5;
      document.getElementById('slideTransitionProp').value = slide.transition || 'fade';
      document.getElementById('transitionDurationProp').value = slide.transitionDuration || 1000;
      document.getElementById('transitionEasingProp').value = slide.transitionEasing || 'linear';
      document.getElementById('slideBackgroundProp').value = slide.background || '';
    }

    // Add event listeners for slide property changes
    document.addEventListener('DOMContentLoaded', function() {
      // Add listeners for slide property inputs
      const slideDurationProp = document.getElementById('slideDurationProp');
      const slideTransitionProp = document.getElementById('slideTransitionProp');
      const transitionDurationProp = document.getElementById('transitionDurationProp');
      const transitionEasingProp = document.getElementById('transitionEasingProp');
      const slideBackgroundProp = document.getElementById('slideBackgroundProp');

      if (slideDurationProp) {
        slideDurationProp.addEventListener('change', function() {
          if (currentSlideIndex !== null) {
            slideData.slides[currentSlideIndex].duration = parseFloat(this.value) * 1000;
            saveCanvasState();
          }
        });
      }

      if (slideTransitionProp) {
        slideTransitionProp.addEventListener('change', function() {
          if (currentSlideIndex !== null) {
            slideData.slides[currentSlideIndex].transition = this.value;
            saveCanvasState();
          }
        });
      }

      if (transitionDurationProp) {
        transitionDurationProp.addEventListener('change', function() {
          if (currentSlideIndex !== null) {
            slideData.slides[currentSlideIndex].transitionDuration = parseInt(this.value);
            saveCanvasState();
          }
        });
      }

      if (transitionEasingProp) {
        transitionEasingProp.addEventListener('change', function() {
          if (currentSlideIndex !== null) {
            slideData.slides[currentSlideIndex].transitionEasing = this.value;
            saveCanvasState();
          }
        });
      }

      if (slideBackgroundProp) {
        slideBackgroundProp.addEventListener('input', function() {
          if (currentSlideIndex !== null) {
            slideData.slides[currentSlideIndex].background = this.value;
            // Update canvas background
            const canvasBg = document.getElementById('canvasBackground');
            if (this.value) {
              canvasBg.style.backgroundImage = `url('${this.value}')`;
              canvasBg.style.opacity = '1';
            } else {
              canvasBg.style.backgroundImage = 'none';
              canvasBg.style.backgroundColor = '#000';
            }
            saveCanvasState();
          }
        });
      }
    });

    // Add transition preview functionality
    function previewTransition() {
      if (currentSlideIndex === null || currentSlideIndex >= slideData.slides.length - 1) {
        showToast('No next slide to preview transition', 2000);
        return;
      }

      const currentSlide = slideData.slides[currentSlideIndex];
      const nextSlide = slideData.slides[currentSlideIndex + 1];

      showToast(`Previewing: ${currentSlide.transition} (${currentSlide.transitionDuration || 1000}ms)`, 2000);

      // Could implement visual transition preview here
      // For now, just show the transition info
    }

    // Add transition preview button to toolbar
    function updateToolbar() {
      const toolbar = document.querySelector('.toolbar');
      if (toolbar && !document.getElementById('previewTransitionBtn')) {
        const previewBtn = document.createElement('button');
        previewBtn.id = 'previewTransitionBtn';
        previewBtn.className = 'tool-btn';
        previewBtn.onclick = previewTransition;
        previewBtn.innerHTML = 'üëÅÔ∏è Preview Transition';
        toolbar.appendChild(previewBtn);
      }
    }

    // Call updateToolbar when WYSIWYG editor loads
    const originalLoadWYSIWYGEditor = loadWYSIWYGEditor;
    loadWYSIWYGEditor = function() {
      originalLoadWYSIWYGEditor();
      updateToolbar();
    };

    // Upload background
    function uploadBackground(input) {
      if (!input.files || !input.files[0]) return;

      const file = input.files[0];
      const formData = new FormData();
      formData.append('file', file);

      fetch('upload-media.php', {
        method: 'POST',
        body: formData
      })
      .then(r => r.json())
      .then(data => {
        if (data.filename) {
          const slide = slideData.slides[currentSlideIndex];
          slide.background = 'media/' + data.filename;
          document.getElementById('slideBackgroundProp').value = slide.background;

          // Update canvas background
          const canvasBg = document.getElementById('canvasBackground');
          canvasBg.style.backgroundImage = `url('${slide.background}')`;

          saveCanvasState();
        }
      })
      .catch(err => {
        showToast('Failed to upload background', 3000);
      });
    }

    // Save canvas state
    function saveCanvasState() {
      // Save to undo stack
      const slide = slideData.slides[currentSlideIndex];
      undoStack.push(JSON.stringify(slide));
      if (undoStack.length > 20) undoStack.shift();
      redoStack = []; // Clear redo stack
    }

    // Save current canvas state before switching
    function saveCurrentCanvasState() {
      if (currentSlideIndex !== null) {
        saveCanvasState();
      }
    }

    // Undo action
    function undoAction() {
      if (undoStack.length > 0) {
        redoStack.push(JSON.stringify(slideData.slides[currentSlideIndex]));
        const previousState = JSON.parse(undoStack.pop());
        slideData.slides[currentSlideIndex] = previousState;
        loadWYSIWYGEditor();
      }
    }

    // Redo action
    function redoAction() {
      if (redoStack.length > 0) {
        undoStack.push(JSON.stringify(slideData.slides[currentSlideIndex]));
        const nextState = JSON.parse(redoStack.pop());
        slideData.slides[currentSlideIndex] = nextState;
        loadWYSIWYGEditor();
      }
    }

    // Duplicate slide
    function duplicateSlide() {
      if (currentSlideIndex === null) return;

      const slide = slideData.slides[currentSlideIndex];
      const duplicate = JSON.parse(JSON.stringify(slide));

      // Reset elements IDs to avoid conflicts
      if (duplicate.elements) {
        duplicate.elements.forEach(el => {
          if (el.id) delete el.id;
        });
      }

      slideData.slides.splice(currentSlideIndex + 1, 0, duplicate);
      selectSlide(currentSlideIndex + 1);
      renderSlidesList();
      renderSlideThumbnails();
      showToast('Slide duplicated');
    }

    // Load version dynamically
    let currentVersion = null;
    const versionEl = document.querySelector('.version');
    
    function loadVersion() {
      fetch('../version.txt?' + Date.now(), { cache: 'no-store' })
        .then(response => response.text())
        .then(version => {
          version = version.trim();
          if (!version) return;
          
          if (currentVersion === null) {
            currentVersion = version;
            console.log('[Version] Current version:', version);
          }
          
          // Update the displayed version
          if (versionEl) {
            versionEl.textContent = `314Sign v${version} | ¬© 2025 J Stekervetz | CC BY-NC 4.0`;
          }
        })
        .catch(error => {
          console.warn('[Version] Failed to load version:', error);
        });
    }
    
    // Initialize
    loadVersion();
    loadSets();
  </script>
</body>
</html>