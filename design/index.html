<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Design Kiosk Page</title>
  <link rel="icon" type="image/svg+xml" href="../favicon.svg" />
  <link href="https://fonts.googleapis.com/css2?family=Indie+Flower&family=Permanent+Marker&family=Caveat&family=Dancing+Script&display=swap" rel="stylesheet">
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    html, body { height:100%; font-family: -apple-system, sans-serif; background:#1a1a1a; color:#e0e0e0; }
    .container {
      display:flex; flex-direction:column; height:100vh;
      padding: max(1rem, env(safe-area-inset-top)) 1rem max(1rem, env(safe-area-inset-bottom));
      gap:1rem;
    }
    h1 { font-size:1.6rem; text-align:center; color:#e0e0e0; }
    .section {
      background:#2d2d2d; padding:1rem; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.3);
    }
    label { display:block; margin:0.5rem 0 0.3rem; font-weight:600; color:#e0e0e0; }
    select, input[type="file"], input[type="text"], input[type="range"] {
      width:100%; padding:0.5rem; font-size:0.9rem; border:2px solid #3a3a3a; border-radius:6px;
      background:#2d2d2d; color:#e0e0e0;
    }
    input[type="range"] {
      padding:0.4rem;
    }
    .bg-grid {
      display:grid; grid-template-columns:repeat(3,1fr); gap:0.5rem; margin-top:0.5rem;
    }
    .bg-thumb {
      width:100%; height:80px; object-fit:cover; border-radius:8px; cursor:pointer;
      border:3px solid transparent; transition:border 0.2s;
    }
    .bg-thumb.selected { border-color:#4a9eff; }
    .preview-img {
      width:100%; max-height:100px; object-fit:contain; border-radius:8px; margin-top:0.5rem;
      border:2px dashed #3a3a3a; display:none; background:#1a1a1a;
    }
    .actions { display:flex; gap:1rem; }
    button {
      flex:1; padding:1rem; font-size:1.1rem; font-weight:600; color:white;
      background:#4a9eff; border:none; border-radius:12px; cursor:pointer;
    }
    button:active { background:#3a8edd; }
    button.secondary { background:#6c757d; }
    button.secondary:active { background:#5a6268; }
    button.danger { background:#dc3545; }
    button.danger:active { background:#c82333; }
    .status { text-align:center; font-size:0.9rem; color:#b0b0b0; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Design Kiosk Page</h1>

    <div class="section">
      <label>1. Background Image</label>
      <div id="bg-grid" class="bg-grid"></div>
      <label style="margin-top:1rem">Or Upload New Image:</label>
      <input type="file" id="upload" accept="image/*" />
      <img id="preview" class="preview-img" src="" />
    </div>

    <div class="section">
      <label>2. Header Font Style</label>
      <select id="headerFont">
        <!-- Populated dynamically from page.json availableFonts -->
      </select>
    </div>

    <div class="section">
      <label>3. Header Text</label>
      <input type="text" id="headerText" placeholder="Specials" maxlength="50" />
    </div>
    
    <div class="section">
      <label for="headerSize">4. Header Size (% of screen): <span id="headerSizeValue">5%</span></label>
      <input type="range" id="headerSize" min="5" max="20" value="5" step="0.5" style="width: 100%" />
    </div>
    
    <div class="section">
      <label for="bgBrightness">5. Background Brightness: <span id="bgBrightnessValue">100%</span></label>
      <input type="range" id="bgBrightness" min="20" max="150" value="100" step="5" style="width: 100%" />
      <small style="color: #666; display: block; margin-top: 0.25rem;">Lower values darken, higher values brighten</small>
    </div>

    <div class="section">
      <label style="display:flex;align-items:center;gap:0.5rem;cursor:pointer">
        <input type="checkbox" id="showClock" style="width:auto;margin:0" />
        <span>Show Clock</span>
      </label>
      <label style="display:flex;align-items:center;gap:0.5rem;cursor:pointer;margin-top:0.5rem;margin-left:1.5rem">
        <input type="checkbox" id="clock24Hour" style="width:auto;margin:0" />
        <span>24-Hour Format</span>
      </label>
    </div>

    <div class="section">
      <label>6. Auto-Format Colors</label>
      <small style="color: #999; display: block; margin-bottom: 0.75rem;">Choose colors for the âœ¨ Auto-Format button in the editor</small>
      
      <label style="font-size: 0.9rem; margin-top: 0.5rem;">Item Names:</label>
      <select id="autoFormatItemColor">
        <option value="w">âšª White</option>
        <option value="r">ðŸ”´ Red</option>
        <option value="y">ðŸŸ¡ Yellow</option>
        <option value="g">ðŸŸ¢ Green</option>
        <option value="b">ðŸ”µ Blue</option>
        <option value="o">ðŸŸ  Orange</option>
        <option value="p">ðŸŸ£ Pink</option>
        <option value="lg">âš« Light Grey</option>
      </select>
      
      <label style="font-size: 0.9rem; margin-top: 0.5rem;">Prices:</label>
      <select id="autoFormatPriceColor">
        <option value="w">âšª White</option>
        <option value="r">ðŸ”´ Red</option>
        <option value="y">ðŸŸ¡ Yellow</option>
        <option value="g">ðŸŸ¢ Green</option>
        <option value="b">ðŸ”µ Blue</option>
        <option value="o">ðŸŸ  Orange</option>
        <option value="p">ðŸŸ£ Pink</option>
        <option value="lg">âš« Light Grey</option>
      </select>
      
      <label style="font-size: 0.9rem; margin-top: 0.5rem;">Descriptions:</label>
      <select id="autoFormatDescColor">
        <option value="w">âšª White</option>
        <option value="r">ðŸ”´ Red</option>
        <option value="y">ðŸŸ¡ Yellow</option>
        <option value="g">ðŸŸ¢ Green</option>
        <option value="b">ðŸ”µ Blue</option>
        <option value="o">ðŸŸ  Orange</option>
        <option value="p">ðŸŸ£ Pink</option>
        <option value="lg">âš« Light Grey</option>
      </select>
    </div>

    <div class="section">
      <label>7. Logo (Optional)</label>
      <small style="color: #999; display: block; margin-bottom: 0.75rem;">Display a logo on the kiosk menu pages</small>
      
      <label style="font-size: 0.9rem; margin-top: 0.5rem;">Logo File:</label>
      <select id="logoFile">
        <option value="">None</option>
        <!-- Populated from media/ directory -->
      </select>
      
      <label style="margin-top:1rem">Or Upload New Logo:</label>
      <input type="file" id="logoUpload" accept="image/*" />
      <img id="logoPreview" class="preview-img" src="" />
      
      <label style="font-size: 0.9rem; margin-top: 0.5rem;">Position:</label>
      <select id="logoPosition">
        <option value="top-left">Top Left</option>
        <option value="bottom-left">Bottom Left</option>
        <option value="bottom-right">Bottom Right</option>
      </select>
      
      <label for="logoSize" style="font-size: 0.9rem; margin-top: 0.5rem;">Size (% of screen width): <span id="logoSizeValue">15%</span></label>
      <input type="range" id="logoSize" min="5" max="40" value="15" step="1" style="width: 100%" />
      
      <label for="logoOpacity" style="font-size: 0.9rem; margin-top: 0.5rem;">Opacity: <span id="logoOpacityValue">100%</span></label>
      <input type="range" id="logoOpacity" min="10" max="100" value="100" step="5" style="width: 100%" />
    </div>

    <div class="actions">
      <button onclick="saveDesign()">Save & Update Kiosk</button>
      <button class="secondary" onclick="location.reload()">Cancel</button>
    </div>
    
    <div class="status" id="status"></div>
    <!-- Toast notification (mobile friendly) -->
    <div id="toast" class="toast" aria-live="polite" role="status" style="display:none"></div>
    <div style="position:fixed;bottom:0.5rem;right:0.5rem;font-size:0.7rem;color:#999;opacity:0.6;pointer-events:none">314Sign v0.9.2.1 | Â© 2025 J Stekervetz | CC BY-NC 4.0</div>
  </div>

  <script>
    const bgGrid = document.getElementById('bg-grid');
    const upload = document.getElementById('upload');
    const preview = document.getElementById('preview');
    const logoUpload = document.getElementById('logoUpload');
    const logoPreview = document.getElementById('logoPreview');
    const headerFontSelect = document.getElementById('headerFont');
    const headerTextInput = document.getElementById('headerText');
    const headerSizeInput = document.getElementById('headerSize');
    const headerSizeValue = document.getElementById('headerSizeValue');
    const bgBrightnessInput = document.getElementById('bgBrightness');
    const bgBrightnessValue = document.getElementById('bgBrightnessValue');
    const showClockCheckbox = document.getElementById('showClock');
    const clock24HourCheckbox = document.getElementById('clock24Hour');
    const autoFormatItemColor = document.getElementById('autoFormatItemColor');
    const autoFormatPriceColor = document.getElementById('autoFormatPriceColor');
    const autoFormatDescColor = document.getElementById('autoFormatDescColor');
    const logoFileSelect = document.getElementById('logoFile');
    const logoPositionSelect = document.getElementById('logoPosition');
    const logoSizeInput = document.getElementById('logoSize');
    const logoSizeValue = document.getElementById('logoSizeValue');
    const logoOpacityInput = document.getElementById('logoOpacity');
    const logoOpacityValue = document.getElementById('logoOpacityValue');
    const status = document.getElementById('status');
    
    // Update header size display
    headerSizeInput.addEventListener('input', () => {
      headerSizeValue.textContent = headerSizeInput.value + '%';
    });
    
    // Update background brightness display
    bgBrightnessInput.addEventListener('input', () => {
      bgBrightnessValue.textContent = bgBrightnessInput.value + '%';
    });
    
    // Update logo size display
    logoSizeInput.addEventListener('input', () => {
      logoSizeValue.textContent = logoSizeInput.value + '%';
    });
    
    // Update logo opacity display
    logoOpacityInput.addEventListener('input', () => {
      logoOpacityValue.textContent = logoOpacityInput.value + '%';
    });
    
    // Handle logo file selection from dropdown
    logoFileSelect.addEventListener('change', () => {
      if (logoFileSelect.value) {
        selectedLogo = logoFileSelect.value;
        uploadedLogoDataUrl = null;
        logoPreview.style.display = 'none';
      } else {
        selectedLogo = null;
        uploadedLogoDataUrl = null;
        logoPreview.style.display = 'none';
      }
    });

  let backgrounds = [];        // Filled from server
  let selectedBg = null;       // Filename or 'uploaded'
  let uploadedDataUrl = null;
  let uploadedFileName = null; // original filename from file input
  
  let selectedLogo = null;     // Logo filename or 'uploaded'
  let uploadedLogoDataUrl = null;
  let uploadedLogoFileName = null;

    // === 1. Load existing images from /bg/ ===
    function loadBackgrounds() {
      fetch('../bg/index.php')
        .then(r => r.json())
        .then(files => {
          backgrounds = files;
          renderThumbs();
          loadLogoFiles();
        })
        .catch(err => {
          console.error(err);
          status.textContent = 'Warning: Could not load backgrounds.';
          backgrounds = [];
          renderThumbs();
          loadLogoFiles();
        });
    }
    
    // === Load logo files from media/ directory ===
    function loadLogoFiles() {
      fetch('../media/index.php?' + Date.now())
        .then(r => {
          if (!r.ok) {
            console.warn('media/index.php returned', r.status);
            throw new Error('HTTP ' + r.status + ': ' + r.statusText);
          }
          return r.text();
        })
        .then(text => {
          console.log('[Logo Files] Raw response from media/index.php:', text);
          
          // Check if response looks like JSON
          if (!text.trim().startsWith('[') && !text.trim().startsWith('{')) {
            console.error('[Logo Files] Response is not JSON:', text.substring(0, 100));
            throw new Error('Invalid JSON response from media/index.php');
          }
          
          return JSON.parse(text);
        })
        .then(files => {
          console.log('[Logo Files] Successfully loaded:', files);
          logoFileSelect.innerHTML = '<option value="">None</option>';
          
          if (Array.isArray(files) && files.length > 0) {
            files.forEach(file => {
              const option = document.createElement('option');
              option.value = file;
              option.textContent = file;
              logoFileSelect.appendChild(option);
            });
            console.log('[Logo Files] Dropdown populated with', files.length, 'files:', files);
          } else {
            console.warn('[Logo Files] No logo files found in media/ directory (empty array)');
          }
          loadConfig();
        })
        .catch(err => {
          console.error('[Logo Files] Failed to load:', err);
          console.warn('[Logo Files] This is expected if testing locally without PHP server');
          console.warn('[Logo Files] On production with PHP, check that media/index.php is accessible');
          // Add "None" option even if fetch fails
          logoFileSelect.innerHTML = '<option value="">None</option>';
          loadConfig();
        });
    }

    // === 2. Render thumbnails ===
    function renderThumbs() {
      bgGrid.innerHTML = '';
      backgrounds.forEach(file => {
        const img = document.createElement('img');
        img.src = '../bg/' + file;
        img.className = 'bg-thumb';
        img.dataset.file = file;
        if (file === selectedBg) img.classList.add('selected');
        img.onclick = () => selectBg(file, img);
        bgGrid.appendChild(img);
      });
    }

    function selectBg(file, thumb) {
      selectedBg = file;
      uploadedDataUrl = null;
      preview.style.display = 'none';
      document.querySelectorAll('.bg-thumb').forEach(t => t.classList.remove('selected'));
      thumb.classList.add('selected');
    }

    // === 3. Handle file upload (preview only) ===
    upload.onchange = () => {
      const file = upload.files[0];
      if (!file) return;
      uploadedFileName = file.name || 'upload.jpg';
      const reader = new FileReader();
      reader.onload = e => {
        uploadedDataUrl = e.target.result;
        preview.src = uploadedDataUrl;
        preview.style.display = 'block';
        selectedBg = 'uploaded';
        document.querySelectorAll('.bg-thumb').forEach(t => t.classList.remove('selected'));
      };
      reader.readAsDataURL(file);
    };
    
    // === Handle logo upload (preview only) ===
    logoUpload.onchange = () => {
      const file = logoUpload.files[0];
      if (!file) return;
      uploadedLogoFileName = file.name || 'logo.png';
      const reader = new FileReader();
      reader.onload = e => {
        uploadedLogoDataUrl = e.target.result;
        logoPreview.src = uploadedLogoDataUrl;
        logoPreview.style.display = 'block';
        selectedLogo = 'uploaded';
        logoFileSelect.value = ''; // Deselect dropdown when uploading
      };
      reader.readAsDataURL(file);
    };

    // === 4. Load saved config and populate fonts ===
    function loadConfig() {
      // Load config to get fonts list
      fetch('../page.json?' + Date.now(), { cache: 'no-store' })
        .then(r => r.ok ? r.json() : {})
        .then(cfg => {
          console.log('[Config] Loaded config:', cfg);
          // Get fonts from config (already includes custom fonts with nice names)
          const fonts = cfg.availableFonts || {
            "Lato": "Lato, sans-serif",
            "DejaVu Sans": "'DejaVu Sans', sans-serif"
          };
          
          // Populate font dropdown
          headerFontSelect.innerHTML = '';
          Object.entries(fonts).forEach(([name, value]) => {                
            const headerOption = document.createElement('option');
            headerOption.value = value;
            headerOption.textContent = name;
            headerFontSelect.appendChild(headerOption);
          });
          console.log('Fonts loaded:', Object.keys(fonts).length + ' fonts');
          
          if (cfg.bg) {
            if (cfg.bg.startsWith('data:')) {
              // Uploaded image
              selectedBg = 'uploaded';
              uploadedDataUrl = cfg.bg;
              preview.src = uploadedDataUrl;
              preview.style.display = 'block';
            } else {
              selectedBg = cfg.bg;
              const thumb = document.querySelector(`.bg-thumb[data-file="${cfg.bg}"]`);
              if (thumb) thumb.classList.add('selected');
            }
          }
          
          // Set the header font (defaults to body font if not set)
          if (cfg.headerFont) {
            headerFontSelect.value = cfg.headerFont;
            console.log('[Config] Header font from config:', cfg.headerFont);
            console.log('[Config] Dropdown value after set:', headerFontSelect.value);
            console.log('[Config] Selected option text:', headerFontSelect.options[headerFontSelect.selectedIndex]?.text);
          } else if (cfg.font) {
            headerFontSelect.value = cfg.font;
            console.log('[Config] Header font defaulted to body font:', cfg.font);
          }
          
          // Load header text
          if (cfg.headerText) {
            headerTextInput.value = cfg.headerText;
          }
          
          // Load header size
          if (Number.isFinite(cfg.headerSizePercent)) {
            headerSizeInput.value = cfg.headerSizePercent;
            headerSizeValue.textContent = cfg.headerSizePercent + '%';
          }
          
          // Load clock setting
          if (cfg.showClock) {
            showClockCheckbox.checked = true;
          }
          
          // Load clock format (default to 24-hour)
          if (cfg.clock24Hour !== false) {
            clock24HourCheckbox.checked = true;
          }
          
          // Load background brightness
          if (Number.isFinite(cfg.bgBrightness)) {
            bgBrightnessInput.value = cfg.bgBrightness * 100;
            bgBrightnessValue.textContent = Math.round(cfg.bgBrightness * 100) + '%';
          }
          
          // Load auto-format colors (defaults: white for items, yellow for prices, light grey for descriptions)
          if (cfg.autoFormatItemColor) {
            autoFormatItemColor.value = cfg.autoFormatItemColor;
          }
          if (cfg.autoFormatPriceColor) {
            autoFormatPriceColor.value = cfg.autoFormatPriceColor;
          } else {
            autoFormatPriceColor.value = 'y'; // default yellow
          }
          if (cfg.autoFormatDescColor) {
            autoFormatDescColor.value = cfg.autoFormatDescColor;
          } else {
            autoFormatDescColor.value = 'lg'; // default light grey
          }
          
          // Load logo settings
          if (cfg.logoFile) {
            logoFileSelect.value = cfg.logoFile;
            selectedLogo = cfg.logoFile; // Initialize selectedLogo variable
            console.log('[Config] Logo file loaded:', cfg.logoFile);
          }
          if (cfg.logoPosition) {
            logoPositionSelect.value = cfg.logoPosition;
          } else {
            logoPositionSelect.value = 'bottom-right'; // default
          }
          if (Number.isFinite(cfg.logoSize)) {
            logoSizeInput.value = cfg.logoSize;
            logoSizeValue.textContent = cfg.logoSize + '%';
          }
          if (Number.isFinite(cfg.logoOpacity)) {
            logoOpacityInput.value = cfg.logoOpacity * 100;
            logoOpacityValue.textContent = Math.round(cfg.logoOpacity * 100) + '%';
          }
        })
        .catch(err => {
          console.error('Failed to load config:', err);
          // Provide fallback fonts if config fails
          headerFontSelect.innerHTML = '<option value="Arial, sans-serif">Arial</option>' +
                                       '<option value="Georgia, serif">Georgia</option>' +
                                       '<option value="\'Comic Sans MS\', cursive">Comic Sans</option>';
        });
    }

    // === 5. Save design ===
    function saveDesign() {
      if (!selectedBg) {
        status.textContent = 'Please select a background.';
        return;
      }

      // Disable actions while saving
      const saveBtn = document.querySelector('.actions button');
      const cancelBtn = document.querySelector('.actions button.secondary');
      if (saveBtn) saveBtn.disabled = true;
      if (cancelBtn) cancelBtn.disabled = true;

      status.textContent = 'Saving...';

      // Get form elements
      const headerFontSelect = document.getElementById('headerFont');
      const headerTextInput = document.getElementById('headerText');
      const headerSizeInput = document.getElementById('headerSize');
      const bgBrightnessInput = document.getElementById('bgBrightness');
      const showClockCheckbox = document.getElementById('showClock');
      const clock24HourCheckbox = document.getElementById('clock24Hour');
      const autoFormatItemColor = document.getElementById('autoFormatItemColor');
      const autoFormatPriceColor = document.getElementById('autoFormatPriceColor');
      const autoFormatDescColor = document.getElementById('autoFormatDescColor');
      const logoFileSelect = document.getElementById('logoFile');
      const logoPositionSelect = document.getElementById('logoPosition');
      const logoSizeInput = document.getElementById('logoSize');
      const logoOpacityInput = document.getElementById('logoOpacity');

      // Read existing config first to preserve all settings
      fetch('../page.json')
        .then(r => r.ok ? r.json() : {})
        .then(existingConfig => {
          // Don't merge or modify availableFonts - keep what's in page.json
          
          // Determine selected background
          // selectedBg is already set globally from user interactions

          let configPromise;
          if (selectedBg === 'uploaded' && uploadedDataUrl) {

          let configPromise;
          if (selectedBg === 'uploaded' && uploadedDataUrl) {
            // Upload image first, then save config with the uploaded filename
            configPromise = uploadImageIfNeeded().then(uploadResult => {
              const filename = uploadResult.filename;
              const updatedConfig = {
                ...existingConfig,
                bg: 'bg/' + filename,
                headerFont: headerFontSelect.value.includes(',') ? headerFontSelect.value : headerFontSelect.value + ', sans-serif',
                headerText: headerTextInput.value.trim() || 'Specials',
                headerSizePercent: parseFloat(headerSizeInput.value),
                bgBrightness: parseFloat(bgBrightnessInput.value) / 100,
                showClock: showClockCheckbox.checked,
                clock24Hour: clock24HourCheckbox.checked,
                autoFormatItemColor: autoFormatItemColor.value,
                autoFormatPriceColor: autoFormatPriceColor.value,
                autoFormatDescColor: autoFormatDescColor.value,
                logoFile: selectedLogo === 'uploaded' ? null : (logoFileSelect.value || null),
                logoPosition: logoPositionSelect.value,
                logoSize: parseFloat(logoSizeInput.value),
                logoOpacity: parseFloat(logoOpacityInput.value) / 100
                // Keep existing availableFonts from page.json
              };

              // Save page.json via merge endpoint
              const mergeUrl = '../scripts/merge-config.php';
              console.log('[Save] Saving config to:', mergeUrl);
              console.log('[Save] Config data:', updatedConfig);
              
              return fetch(mergeUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updatedConfig)
              });
            });
          } else {
            // Save config directly
            const updatedConfig = {
              ...existingConfig,
              bg: selectedBg,
              headerFont: headerFontSelect.value.includes(',') ? headerFontSelect.value : headerFontSelect.value + ', sans-serif',
              headerText: headerTextInput.value.trim() || 'Specials',
              headerSizePercent: parseFloat(headerSizeInput.value),
              bgBrightness: parseFloat(bgBrightnessInput.value) / 100,
              showClock: showClockCheckbox.checked,
              clock24Hour: clock24HourCheckbox.checked,
              autoFormatItemColor: autoFormatItemColor.value,
              autoFormatPriceColor: autoFormatPriceColor.value,
              autoFormatDescColor: autoFormatDescColor.value,
              logoFile: selectedLogo === 'uploaded' ? null : (logoFileSelect.value || null),
              logoPosition: logoPositionSelect.value,
              logoSize: parseFloat(logoSizeInput.value),
              logoOpacity: parseFloat(logoOpacityInput.value) / 100
              // Keep existing availableFonts from page.json
            };

            // Save page.json via merge endpoint
            const mergeUrl = '../scripts/merge-config.php';
            console.log('[Save] Saving config to:', mergeUrl);
            console.log('[Save] Config data:', updatedConfig);
            
            configPromise = fetch(mergeUrl, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(updatedConfig)
            });
          }

          return configPromise;
        })
        .then(r => {
          console.log('[Save] Response status:', r.status, r.statusText);
          if (!r.ok) {
            return r.text().then(t => {
              console.error('[Save] Error response:', t.substring(0, 200));
              return Promise.reject('Config save failed: ' + (t.substring(0, 100) || r.statusText));
            });
          }
          return r;
          return Promise.all([
            uploadImageIfNeeded()
          ]);
        });
    }
function uploadImageIfNeeded() {
  if (selectedBg !== 'uploaded' || !uploadedDataUrl) return Promise.resolve();

  // Convert dataURL to Blob (use helper) to preserve MIME and avoid
  // potential CORS issues fetching data: URLs.
  const blob = dataURLtoBlob(uploadedDataUrl);
  const form = new FormData();
  // Use original filename when available
  const name = uploadedFileName || 'upload.jpg';
  form.append('image', blob, name);
  form.append('type', 'bg');

  console.log('[Upload] Attempting upload:', name, blob);

  return fetch('upload.php', {
    method: 'POST',
    body: form
  })
  .then(r => {
    // Try to parse JSON even on non-OK to surface server-side messages
    return r.text().then(text => {
      let data = null;
      try { data = text ? JSON.parse(text) : null; } catch(e) { /* ignore */ }
      console.log('[Upload] Server response:', text);
      if (!r.ok) {
        const errMsg = data && (data.error || data.detail) ? (data.error + (data.detail ? (': ' + data.detail) : '')) : (text || r.statusText);
        return Promise.reject(errMsg);
      }
      return data;
    });
  })
  .then(data => {
    if (data && data.filename) {
      console.log('[Upload] Upload successful, filename:', data.filename);
      selectedBg = data.filename;
      backgrounds.push(data.filename);
      renderThumbs();
      const thumb = document.querySelector(`.bg-thumb[data-file="${data.filename}"]`);
      if (thumb) thumb.classList.add('selected');
      return updateConfigWithNewFilename(data.filename);
    }
    const err = data && (data.error || data.detail) ? (data.error + (data.detail ? (': ' + data.detail) : '')) : 'Upload failed (no filename returned)';
    return Promise.reject(err);
  })
  .catch(err => {
    console.error('[Upload] Upload error:', err);
    status.textContent = 'Upload error: ' + (err && err.message ? err.message : err);
    return Promise.reject(err);
  });
}

    function updateConfigWithNewFilename(filename) {
      // Read existing config and POST partial update to merge endpoint to avoid destructive overwrite
      return fetch('../page.json')
        .then(r => r.ok ? r.json() : {})
        .then(cfg => {
          const patch = { bg: filename };
          return fetch('../scripts/merge-config.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(patch)
          }).then(r => {
            if (!r.ok) return Promise.reject('Failed to update config with filename');
            return r;
          });
        });
    }
    
    // === 6b. Upload new logo via PHP ===
    function uploadLogoIfNeeded() {
      if (selectedLogo !== 'uploaded' || !uploadedLogoDataUrl) return Promise.resolve();

      // Convert dataURL to Blob
      const blob = dataURLtoBlob(uploadedLogoDataUrl);
      const form = new FormData();
      const name = uploadedLogoFileName || 'logo.png';
      form.append('image', blob, name);
      form.append('type', 'logo');

      return fetch('upload.php', {
        method: 'POST',
        body: form
      })
      .then(r => {
        return r.text().then(text => {
          let data = null;
          try { data = text ? JSON.parse(text) : null; } catch(e) { /* ignore */ }
          if (!r.ok) {
            const errMsg = data && (data.error || data.detail) ? (data.error + (data.detail ? (': ' + data.detail) : '')) : (text || r.statusText);
            return Promise.reject(errMsg);
          }
          return data;
        });
      })
      .then(data => {
        if (data && data.filename) {
          selectedLogo = data.filename;
          // Update config with new logo filename
          return updateConfigWithNewLogo(data.filename);
        }
        const err = data && (data.error || data.detail) ? (data.error + (data.detail ? (': ' + data.detail) : '')) : 'Logo upload failed (no filename returned)';
        return Promise.reject(err);
      })
      .catch(err => {
        console.error('Logo upload error:', err);
        status.textContent = 'Logo upload error: ' + (err && err.message ? err.message : err);
        return Promise.reject(err);
      });
    }
    
    function updateConfigWithNewLogo(filename) {
      return fetch('../page.json')
        .then(r => r.ok ? r.json() : {})
        .then(cfg => {
          const patch = { logoFile: filename };
          return fetch('../scripts/merge-config.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(patch)
          }).then(r => {
            if (!r.ok) return Promise.reject('Failed to update config with logo filename');
            return r;
          });
        });
    }

    function dataURLtoBlob(dataurl) {
      const [meta, base64] = dataurl.split(',');
      const mime = meta.match(/:(.*?);/)[1];
      const bstr = atob(base64);
      let n = bstr.length;
      const u8arr = new Uint8Array(n);
      while (n--) u8arr[n] = bstr.charCodeAt(n);
      return new Blob([u8arr], { type: mime });
    }

    // === 7. Generate index.html ===
    function generateIndexHTML() {
      const bgUrl = selectedBg === 'uploaded' ? uploadedDataUrl : 'bg/' + selectedBg;
      const font = fontSelect.value;

      // Escape double quotes in bgUrl for safe insertion into url("...")
      const safeBg = String(bgUrl).replace(/"/g, '\\"');

      // Note: This generator creates a simplified version of index.html
      // The full production version has more features (ETag polling, rules checking, etc.)
      // Consider just updating page.json instead of regenerating the entire file
      
      var html = '';
      html += '<!DOCTYPE html>\n';
      html += '<html lang="en">\n';
      html += '<head>\n';
      html += '  <meta charset="UTF-8" />\n';
      html += '  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>\n';
      html += '  <title>Daily Specials</title>\n';
      html += '  <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"><\/script>\n';
      html += '  <style>\n';
      html += '    * { margin:0; padding:0; box-sizing:border-box; }\n';
      html += '    html, body { height:100%; overflow:hidden; }\n';
      html += '    body {\n';
      html += '      font-family: ' + font + ';\n';
      html += '      color: #fff;\n';
      html += '      text-shadow: 2px 2px 4px rgba(0,0,0,0.7);\n';
      html += '      display: flex;\n';
      html += '      flex-direction: column;\n';
      html += '      position: relative;\n';
      html += '    }\n';
      html += '    /* Background with brightness filter support */\n';
      html += '    body::before {\n';
      html += '      content: \\\'\\\';\n';
      html += '      position: fixed;\n';
      html += '      top: 0;\n';
      html += '      left: 0;\n';
      html += '      width: 100%;\n';
      html += '      height: 100%;\n';
      html += '      background: url("' + safeBg + '") center/cover no-repeat;\n';
      html += '      z-index: -1;\n';
      html += '      filter: brightness(1);\n';
      html += '    }\n';
      html += '    header {\n';
      html += '      background: rgba(0,0,0,0.5);\n';
      html += '      padding: 1rem;\n';
      html += '      text-align: center;\n';
      html += '      font-size: clamp(1.5rem, 5vw, 4rem);\n';
      html += '      font-weight: bold;\n';
      html += '    }\n';
      html += '    #specials {\n';
      html += '      flex: 1;\n';
      html += '      padding: clamp(1rem, 2vw, 3rem);\n';
      html += '      font-size: clamp(1rem, 3vw, 3rem);\n';
      html += '      line-height: 1.6;\n';
      html += '      overflow-y: auto;\n';
      html += '      white-space: pre-wrap;\n';
      html += '      -webkit-overflow-scrolling: touch;\n';
      html += '    }\n';
      html += '    .version { position: fixed; bottom: 0.5rem; right: 0.5rem; font-size: 0.7rem; opacity: 0.5; }\n';
      html += '  </style>\n';
      html += '</head>\n';
      html += '<body>\n';
      html += '  <header>Specials</header>\n';
      html += '  <div id="specials">Loadingâ€¦</div>\n';
      html += '  <div class="version">314Sign v0.9.2.1 | Â© 2025 J Stekervetz | CC BY-NC 4.0</div>\n';
      html += '  <script>\n';
      html += '    const specialsDiv = document.getElementById("specials");\n';
      html += '    let currentMenu = localStorage.getItem("currentMenu") || "menus/dinner.txt";\n';
      html += '    function switchMenu(f) {\n';
      html += '      currentMenu = f;\n';
      html += '      localStorage.setItem("currentMenu", f);\n';
      html += '      fetch(f + "?" + Date.now()).then(r => r.text()).then(t => {\n';
      html += '        specialsDiv.innerHTML = marked.parse(t);\n';
      html += '      });\n';
      html += '    }\n';
      html += '    function checkScheduleRules() {\n';
      html += '      fetch("rules.json?" + Date.now()).then(r => r.ok ? r.json() : null).then(data => {\n';
      html += '        if (!data || !data.enabled || !data.rules) return;\n';
      html += '        const now = new Date();\n';
      html += '        const currentDay = ["sunday","monday","tuesday","wednesday","thursday","friday","saturday"][now.getDay()];\n';
      html += '        const currentTime = now.getHours().toString().padStart(2,"0")+":"+now.getMinutes().toString().padStart(2,"0");\n';
      html += '        for (const rule of data.rules) {\n';
      html += '          if (!rule.days.includes(currentDay)) continue;\n';
      html += '          const startTime = rule.startTime || "00:00";\n';
      html += '          const endTime = rule.endTime || "23:59";\n';
      html += '          let matches = startTime <= endTime ? (currentTime >= startTime && currentTime < endTime) : (currentTime >= startTime || currentTime < endTime);\n';
      html += '          if (matches && rule.menu && rule.menu !== currentMenu) {\n';
      html += '            switchMenu(rule.menu);\n';
      html += '            break;\n';
      html += '          }\n';
      html += '        }\n';
      html += '      });\n';
      html += '    }\n';
      html += '    checkScheduleRules();\n';
      html += '    setInterval(checkScheduleRules, 60000);\n';
      html += '    fetch(currentMenu + "?" + Date.now()).then(r => r.text()).then(t => {\n';
      html += '      let html = marked.parse(t);\n';
      html += '      html = html.replace(/\\\\{r\\\\}(.*?)(<\\\\/|\\\\{[rygbopw]\\\\}|$)/g, \'<span style="color:#ff4444">$1</span>$2\');\n';
      html += '      html = html.replace(/\\\\{y\\\\}(.*?)(<\\\\/|\\\\{[rygbopw]\\\\}|$)/g, \'<span style="color:#ffdd44">$1</span>$2\');\n';
      html += '      html = html.replace(/\\\\{g\\\\}(.*?)(<\\\\/|\\\\{[rygbopw]\\\\}|$)/g, \'<span style="color:#44ff44">$1</span>$2\');\n';
      html += '      html = html.replace(/\\\\{b\\\\}(.*?)(<\\\\/|\\\\{[rygbopw]\\\\}|$)/g, \'<span style="color:#4488ff">$1</span>$2\');\n';
      html += '      html = html.replace(/\\\\{o\\\\}(.*?)(<\\\\/|\\\\{[rygbopw]\\\\}|$)/g, \'<span style="color:#ff8844">$1</span>$2\');\n';
      html += '      html = html.replace(/\\\\{p\\\\}(.*?)(<\\\\/|\\\\{[rygbopw]\\\\}|$)/g, \'<span style="color:#ff44ff">$1</span>$2\');\n';
      html += '      html = html.replace(/\\\\{w\\\\}(.*?)(<\\\\/|\\\\{[rygbopw]\\\\}|$)/g, \'<span style="color:#ffffff">$1</span>$2\');\n';
      html += '      specialsDiv.innerHTML = html;\n';
      html += '    });\n';
      html += '    setInterval(() => fetch(currentMenu + "?" + Date.now()).then(r => r.text()).then(t => {\n';
      html += '      let html = marked.parse(t);\n';
      html += '      html = html.replace(/\\\\{r\\\\}(.*?)(<\\\\/|\\\\{[rygbopw]\\\\}|$)/g, \'<span style="color:#ff4444">$1</span>$2\');\n';
      html += '      html = html.replace(/\\\\{y\\\\}(.*?)(<\\\\/|\\\\{[rygbopw]\\\\}|$)/g, \'<span style="color:#ffdd44">$1</span>$2\');\n';
      html += '      html = html.replace(/\\\\{g\\\\}(.*?)(<\\\\/|\\\\{[rygbopw]\\\\}|$)/g, \'<span style="color:#44ff44">$1</span>$2\');\n';
      html += '      html = html.replace(/\\\\{b\\\\}(.*?)(<\\\\/|\\\\{[rygbopw]\\\\}|$)/g, \'<span style="color:#4488ff">$1</span>$2\');\n';
      html += '      html = html.replace(/\\\\{o\\\\}(.*?)(<\\\\/|\\\\{[rygbopw]\\\\}|$)/g, \'<span style="color:#ff8844">$1</span>$2\');\n';
      html += '      html = html.replace(/\\\\{p\\\\}(.*?)(<\\\\/|\\\\{[rygbopw]\\\\}|$)/g, \'<span style="color:#ff44ff">$1</span>$2\');\n';
      html += '      html = html.replace(/\\\\{w\\\\}(.*?)(<\\\\/|\\\\{[rygbopw]\\\\}|$)/g, \'<span style="color:#ffffff">$1</span>$2\');\n';
      html += '      specialsDiv.innerHTML = html;\n';
      html += '    }), 3000);\n';
      html += '    setInterval(() => location.reload(), 300000);\n';
      html += '  <\/script>\n';
      html += '</body>\n';
      html += '</html>\n';

      return fetch('../index.html', {
        method: 'PUT',
        headers: { 'Content-Type': 'text/html' },
        body: html
      });
    }

    // === Start ===
    // Load backgrounds and then config (which populates fonts)
    loadBackgrounds();
    
    // Check for version updates and force reload
    let currentVersion = null;
    function checkVersion() {
      fetch('../version.txt?' + Date.now(), { cache: 'no-store' })
        .then(r => r.ok ? r.text() : '')
        .then(version => {
          version = version.trim();
          if (!version) return;
          
          if (currentVersion === null) {
            currentVersion = version;
            console.log('[Version] Current version:', version);
          } else if (version !== currentVersion) {
            console.log('[Version] Update detected:', currentVersion, '->', version);
            showToast('Update detected - reloading...', 'info');
            setTimeout(() => location.reload(true), 1500);
          }
        })
        .catch(() => {});
    }
    checkVersion();
    setInterval(checkVersion, 30000); // Check every 30 seconds
    
    // Also load fonts immediately as a backup to ensure they're available
    setTimeout(() => {
      const fontSelect = document.getElementById('headerFont');
      fetch('../page.json')
        .then(r => r.ok ? r.json() : {})
        .then(cfg => {
          if (cfg.availableFonts && fontSelect.children.length === 0) {
            Object.entries(cfg.availableFonts).forEach(([name, value]) => {
              const option = document.createElement('option');
              option.value = value;
              option.textContent = name;
              fontSelect.appendChild(option);
            });
            if (cfg.font) fontSelect.value = cfg.font;
          }
        })
        .catch(err => console.error('Fallback font load failed:', err));
    }, 100);

    // === Toast helper ===
    (function(){
      // Create styles for toast
      const css = `
      .toast {
        position: fixed;
        left: 50%;
        bottom: max(1.25rem, env(safe-area-inset-bottom));
        transform: translateX(-50%);
        background: rgba(0,0,0,0.85);
        color: #fff;
        padding: 0.75rem 1rem;
        border-radius: 10px;
        font-size: 1rem;
        min-width: 160px;
        max-width: 92%;
        text-align: center;
        z-index: 9999;
        box-shadow: 0 6px 18px rgba(0,0,0,0.25);
        -webkit-backdrop-filter: blur(6px);
        backdrop-filter: blur(6px);
      }
      @media (prefers-reduced-motion: no-preference) {
        .toast.show { animation: toast-in 240ms ease-out; }
      }
      @keyframes toast-in { from { transform: translateX(-50%) translateY(8px); opacity: 0 } to { transform: translateX(-50%) translateY(0); opacity: 1 }}
      `;
      const s = document.createElement('style'); s.textContent = css; document.head.appendChild(s);

      let toastTimer = null;
      window.showToast = function(msg, ms=3000) {
        const el = document.getElementById('toast');
        if (!el) return;
        el.textContent = msg;
        el.style.display = 'block';
        el.classList.add('show');
        if (toastTimer) clearTimeout(toastTimer);
        toastTimer = setTimeout(() => {
          el.classList.remove('show');
          el.style.display = 'none';
        }, ms);
      };
    })();
  </script>
</body>
</html>