<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Design Kiosk Page</title>
  <link rel="icon" type="image/svg+xml" href="../favicon.svg" />
  <link href="https://fonts.googleapis.com/css2?family=Indie+Flower&family=Permanent+Marker&family=Caveat&family=Dancing+Script&display=swap" rel="stylesheet">
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    html, body { height:100%; font-family: -apple-system, sans-serif; background:#1a1a1a; color:#e0e0e0; }
    .container {
      display:flex; flex-direction:column; height:100vh;
      padding: max(1rem, env(safe-area-inset-top)) 1rem max(1rem, env(safe-area-inset-bottom));
      gap:1rem;
    }
    h1 { font-size:1.6rem; text-align:center; color:#e0e0e0; }
    .section {
      background:#2d2d2d; padding:1rem; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.3);
    }
    label { display:block; margin:0.5rem 0 0.3rem; font-weight:600; color:#e0e0e0; }
    select, input[type="file"] {
      width:100%; padding:0.8rem; font-size:1rem; border:2px solid #3a3a3a; border-radius:8px;
      background:#1a1a1a; color:#e0e0e0;
    }
    .bg-grid {
      display:grid; grid-template-columns:repeat(3,1fr); gap:0.5rem; margin-top:0.5rem;
    }
    .bg-thumb {
      width:100%; height:80px; object-fit:cover; border-radius:8px; cursor:pointer;
      border:3px solid transparent; transition:border 0.2s;
    }
    .bg-thumb.selected { border-color:#4a9eff; }
    .preview-img {
      width:100%; height:180px; object-fit:cover; border-radius:8px; margin-top:0.5rem;
      border:2px dashed #3a3a3a; display:none;
    }
    .actions { display:flex; gap:1rem; }
    button {
      flex:1; padding:1rem; font-size:1.1rem; font-weight:600; color:white;
      background:#4a9eff; border:none; border-radius:12px; cursor:pointer;
    }
    button:active { background:#3a8edd; }
    button.secondary { background:#6c757d; }
    button.secondary:active { background:#5a6268; }
    button.danger { background:#dc3545; }
    button.danger:active { background:#c82333; }
    .status { text-align:center; font-size:0.9rem; color:#b0b0b0; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Design Kiosk Page</h1>

    <div class="section">
      <label>1. Background Image</label>
      <div id="bg-grid" class="bg-grid"></div>
      <label style="margin-top:1rem">Or Upload New Image:</label>
      <input type="file" id="upload" accept="image/*" />
      <img id="preview" class="preview-img" src="" />
    </div>

    <div class="section">
      <label>2. Body Font Style</label>
      <select id="font">
        <!-- Populated dynamically from config.json availableFonts -->
      </select>
    </div>

    <div class="section">
      <label>3. Header Font Style</label>
      <select id="headerFont">
        <!-- Populated dynamically from config.json availableFonts -->
      </select>
    </div>

    <div class="section">
      <label>4. Header Text</label>
      <input type="text" id="headerText" placeholder="Specials" maxlength="50" />
    </div>
    
    <div class="section">
      <label for="headerSize">5. Header Size (% of screen): <span id="headerSizeValue">5%</span></label>
      <input type="range" id="headerSize" min="5" max="20" value="5" step="0.5" style="width: 100%" />
    </div>
    
    <div class="section">
      <label for="bgBrightness">6. Background Brightness: <span id="bgBrightnessValue">100%</span></label>
      <input type="range" id="bgBrightness" min="20" max="150" value="100" step="5" style="width: 100%" />
      <small style="color: #666; display: block; margin-top: 0.25rem;">Lower values darken, higher values brighten</small>
    </div>

    <div class="section">
      <label style="display:flex;align-items:center;gap:0.5rem;cursor:pointer">
        <input type="checkbox" id="showClock" style="width:auto;margin:0" />
        <span>Show Clock</span>
      </label>
      <label style="display:flex;align-items:center;gap:0.5rem;cursor:pointer;margin-top:0.5rem;margin-left:1.5rem">
        <input type="checkbox" id="clock24Hour" style="width:auto;margin:0" />
        <span>24-Hour Format</span>
      </label>
    </div>

    <div class="actions">
      <button onclick="saveDesign()">Save & Update Kiosk</button>
      <button class="secondary" onclick="location.reload()">Cancel</button>
    </div>
    
    <div class="section" style="margin-top: 1rem; border: 2px solid #dc3545;">
      <label style="color: #dc3545; font-weight: 700;">⚠️ Danger Zone</label>
      <p style="font-size: 0.9rem; color: #666; margin: 0.5rem 0;">Delete all menu history files (7-day backup). This action cannot be undone.</p>
      <button class="danger" onclick="purgeHistory()" style="margin-top: 0.5rem;">Purge All History</button>
    </div>
    
    <div class="status" id="status"></div>
    <!-- Toast notification (mobile friendly) -->
    <div id="toast" class="toast" aria-live="polite" role="status" style="display:none"></div>
    <div style="position:fixed;bottom:0.5rem;right:0.5rem;font-size:0.7rem;color:#999;opacity:0.6;pointer-events:none">314Sign v0.9.1 | © 2025 J Stekervetz | CC BY-NC 4.0</div>
  </div>

  <script>
    const bgGrid = document.getElementById('bg-grid');
    const upload = document.getElementById('upload');
    const preview = document.getElementById('preview');
    const fontSelect = document.getElementById('font');
    const headerFontSelect = document.getElementById('headerFont');
    const headerTextInput = document.getElementById('headerText');
    const headerSizeInput = document.getElementById('headerSize');
    const headerSizeValue = document.getElementById('headerSizeValue');
    const bgBrightnessInput = document.getElementById('bgBrightness');
    const bgBrightnessValue = document.getElementById('bgBrightnessValue');
    const showClockCheckbox = document.getElementById('showClock');
    const clock24HourCheckbox = document.getElementById('clock24Hour');
    const status = document.getElementById('status');
    
    // Update header size display
    headerSizeInput.addEventListener('input', () => {
      headerSizeValue.textContent = headerSizeInput.value + '%';
    });
    
    // Update background brightness display
    bgBrightnessInput.addEventListener('input', () => {
      bgBrightnessValue.textContent = bgBrightnessInput.value + '%';
    });

  let backgrounds = [];        // Filled from server
  let selectedBg = null;       // Filename or 'uploaded'
  let uploadedDataUrl = null;
  let uploadedFileName = null; // original filename from file input

    // === 1. Load existing images from /bg/ ===
    function loadBackgrounds() {
      fetch('../bg/index.php')
        .then(r => r.json())
        .then(files => {
          backgrounds = files;
          renderThumbs();
          loadConfig();
        })
        .catch(err => {
          console.error(err);
          status.textContent = 'Warning: Could not load backgrounds.';
          backgrounds = [];
          renderThumbs();
          loadConfig();
        });
    }

    // === 2. Render thumbnails ===
    function renderThumbs() {
      bgGrid.innerHTML = '';
      backgrounds.forEach(file => {
        const img = document.createElement('img');
        img.src = '../bg/' + file;
        img.className = 'bg-thumb';
        img.dataset.file = file;
        if (file === selectedBg) img.classList.add('selected');
        img.onclick = () => selectBg(file, img);
        bgGrid.appendChild(img);
      });
    }

    function selectBg(file, thumb) {
      selectedBg = file;
      uploadedDataUrl = null;
      preview.style.display = 'none';
      document.querySelectorAll('.bg-thumb').forEach(t => t.classList.remove('selected'));
      thumb.classList.add('selected');
    }

    // === 3. Handle file upload (preview only) ===
    upload.onchange = () => {
      const file = upload.files[0];
      if (!file) return;
      uploadedFileName = file.name || 'upload.jpg';
      const reader = new FileReader();
      reader.onload = e => {
        uploadedDataUrl = e.target.result;
        preview.src = uploadedDataUrl;
        preview.style.display = 'block';
        selectedBg = 'uploaded';
        document.querySelectorAll('.bg-thumb').forEach(t => t.classList.remove('selected'));
      };
      reader.readAsDataURL(file);
    };

    // === 4. Load saved config and populate fonts ===
    function loadConfig() {
      fetch('../config.json')
        .then(r => r.ok ? r.json() : {})
        .then(cfg => {
          // Populate font dropdown from config.availableFonts
          // If not present, use default font list
          const fonts = cfg.availableFonts || {
            "Comic Sans": "'Comic Sans MS', cursive",
            "Chalkboard": "'Chalkboard', 'Chalkboard SE', cursive",
            "Chalkduster": "'Chalkduster', cursive",
            "Arial": "Arial, sans-serif",
            "Helvetica": "'Helvetica Neue', Helvetica, sans-serif",
            "Georgia": "Georgia, serif",
            "Times New Roman": "'Times New Roman', Times, serif",
            "Courier New": "'Courier New', monospace",
            "Verdana": "Verdana, sans-serif",
            "Trebuchet MS": "'Trebuchet MS', sans-serif",
            "Lucida Console": "'Lucida Console', monospace",
            "Impact": "Impact, fantasy",
            "Palatino": "'Palatino Linotype', 'Book Antiqua', Palatino, serif",
            "Garamond": "Garamond, serif"
          };
          
          fontSelect.innerHTML = '';
          headerFontSelect.innerHTML = '';
          Object.entries(fonts).forEach(([name, value]) => {
            const option = document.createElement('option');
            option.value = value;
            option.textContent = name;
            fontSelect.appendChild(option);
            
            const headerOption = document.createElement('option');
            headerOption.value = value;
            headerOption.textContent = name;
            headerFontSelect.appendChild(headerOption);
          });
          console.log('Fonts loaded:', Object.keys(fonts).length + ' fonts');
          
          if (cfg.bg) {
            if (cfg.bg.startsWith('data:')) {
              // Uploaded image
              selectedBg = 'uploaded';
              uploadedDataUrl = cfg.bg;
              preview.src = uploadedDataUrl;
              preview.style.display = 'block';
            } else {
              selectedBg = cfg.bg;
              const thumb = document.querySelector(`.bg-thumb[data-file="${cfg.bg}"]`);
              if (thumb) thumb.classList.add('selected');
            }
          }
          
          // Set the selected font after options are populated
          if (cfg.font) {
            fontSelect.value = cfg.font;
            console.log('Font set to:', cfg.font);
          }
          
          // Set the header font (defaults to body font if not set)
          if (cfg.headerFont) {
            headerFontSelect.value = cfg.headerFont;
            console.log('Header font set to:', cfg.headerFont);
          } else if (cfg.font) {
            headerFontSelect.value = cfg.font;
          }
          
          // Load header text
          if (cfg.headerText) {
            headerTextInput.value = cfg.headerText;
          }
          
          // Load header size
          if (Number.isFinite(cfg.headerSizePercent)) {
            headerSizeInput.value = cfg.headerSizePercent;
            headerSizeValue.textContent = cfg.headerSizePercent + '%';
          }
          
          // Load clock setting
          if (cfg.showClock) {
            showClockCheckbox.checked = true;
          }
          
          // Load clock format (default to 24-hour)
          if (cfg.clock24Hour !== false) {
            clock24HourCheckbox.checked = true;
          }
          
          // Load background brightness
          if (Number.isFinite(cfg.bgBrightness)) {
            bgBrightnessInput.value = cfg.bgBrightness * 100;
            bgBrightnessValue.textContent = Math.round(cfg.bgBrightness * 100) + '%';
          }
        })
        .catch(err => {
          console.error('Failed to load config:', err);
          // Provide fallback fonts if config fails
          fontSelect.innerHTML = '<option value="Arial, sans-serif">Arial</option>' +
                                 '<option value="Georgia, serif">Georgia</option>' +
                                 '<option value="\'Comic Sans MS\', cursive">Comic Sans</option>';
        });
    }

    // === 5. Save design ===
    function saveDesign() {
      if (!selectedBg) {
        status.textContent = 'Please select a background.';
        return;
      }

      // Disable actions while saving
      const saveBtn = document.querySelector('.actions button');
      const cancelBtn = document.querySelector('.actions button.secondary');
      if (saveBtn) saveBtn.disabled = true;
      if (cancelBtn) cancelBtn.disabled = true;

      status.textContent = 'Saving...';

      // Read existing config first to preserve all settings
      fetch('../config.json')
        .then(r => r.ok ? r.json() : {})
        .then(existingConfig => {
          // Ensure availableFonts exists with all default fonts including chalkboard
          const defaultFonts = {
            "Comic Sans": "'Comic Sans MS', cursive",
            "Chalkboard": "'Chalkboard', 'Chalkboard SE', cursive",
            "Chalkduster": "'Chalkduster', cursive",
            "Arial": "Arial, sans-serif",
            "Helvetica": "'Helvetica Neue', Helvetica, sans-serif",
            "Georgia": "Georgia, serif",
            "Times New Roman": "'Times New Roman', Times, serif",
            "Courier New": "'Courier New', monospace",
            "Verdana": "Verdana, sans-serif",
            "Trebuchet MS": "'Trebuchet MS', sans-serif",
            "Lucida Console": "'Lucida Console', monospace",
            "Impact": "Impact, fantasy",
            "Palatino": "'Palatino Linotype', 'Book Antiqua', Palatino, serif",
            "Garamond": "Garamond, serif"
          };
          
          // Merge existing availableFonts with defaults to add any missing fonts
          const mergedFonts = {
            ...defaultFonts,
            ...(existingConfig.availableFonts || {})
          };
          
          const updatedConfig = {
            ...existingConfig,
            bg: selectedBg === 'uploaded' ? uploadedDataUrl : selectedBg,
            font: fontSelect.value,
            headerFont: headerFontSelect.value,
            headerText: headerTextInput.value.trim() || 'Specials',
            headerSizePercent: parseFloat(headerSizeInput.value),
            bgBrightness: parseFloat(bgBrightnessInput.value) / 100,
            showClock: showClockCheckbox.checked,
            clock24Hour: clock24HourCheckbox.checked,
            availableFonts: mergedFonts
          };

          // Save config.json
          return fetch('../config.json', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updatedConfig, null, 2)
          });
        })
        .then(r => {
          if (!r.ok) return r.text().then(t => Promise.reject('Config save failed: ' + (t || r.statusText)));
          return uploadImageIfNeeded();
        })
      // Skip generateIndexHTML - config.json changes are enough
      // The live index.html reads config dynamically at runtime
      .then(() => {
        status.textContent = 'Saved! Kiosk updated.';
        // Show mobile-friendly toast as confirmation
        if (window.showToast) showToast('Saved — kiosk updated');
        
        // Trigger kiosk reload immediately
        fetch('../trigger-reload.php', {
          method: 'POST'
        }).catch(() => {});
        
        setTimeout(() => status.textContent = '', 3000);
      })
      .catch(err => {
        console.error('Save error:', err);
        status.textContent = 'Error: ' + (err && err.message ? err.message : err);
      })
      .finally(() => {
        if (saveBtn) saveBtn.disabled = false;
        if (cancelBtn) cancelBtn.disabled = false;
      });
    }

    // === 6. Upload new image via PHP ===
    function uploadImageIfNeeded() {
      if (selectedBg !== 'uploaded' || !uploadedDataUrl) return Promise.resolve();

      // Convert dataURL to Blob (use helper) to preserve MIME and avoid
      // potential CORS issues fetching data: URLs.
      const blob = dataURLtoBlob(uploadedDataUrl);
      const form = new FormData();
      // Use original filename when available
      const name = uploadedFileName || 'upload.jpg';
      form.append('image', blob, name);

      return fetch('upload-bg.php', {
        method: 'POST',
        body: form
      })
      .then(r => {
        // Try to parse JSON even on non-OK to surface server-side messages
        return r.text().then(text => {
          let data = null;
          try { data = text ? JSON.parse(text) : null; } catch(e) { /* ignore */ }
          if (!r.ok) {
            const errMsg = data && (data.error || data.detail) ? (data.error + (data.detail ? (': ' + data.detail) : '')) : (text || r.statusText);
            return Promise.reject(errMsg);
          }
          return data;
        });
      })
      .then(data => {
        if (data && data.filename) {
          selectedBg = data.filename;
          backgrounds.push(data.filename);
          renderThumbs();
          const thumb = document.querySelector(`.bg-thumb[data-file="${data.filename}"]`);
          if (thumb) thumb.classList.add('selected');
          return updateConfigWithNewFilename(data.filename);
        }
        const err = data && (data.error || data.detail) ? (data.error + (data.detail ? (': ' + data.detail) : '')) : 'Upload failed (no filename returned)';
        return Promise.reject(err);
      })
      .catch(err => {
        console.error('Upload error:', err);
        // Surface server-side error to user
        status.textContent = 'Upload error: ' + (err && err.message ? err.message : err);
        return Promise.reject(err);
      });
    }

    function updateConfigWithNewFilename(filename) {
      return fetch('../config.json')
        .then(r => r.ok ? r.json() : {})
        .then(cfg => {
          cfg.bg = filename;
          return fetch('../config.json', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(cfg)
          }).then(r => {
            if (!r.ok) return Promise.reject('Failed to update config with filename');
            return r;
          });
        });
    }

    function dataURLtoBlob(dataurl) {
      const [meta, base64] = dataurl.split(',');
      const mime = meta.match(/:(.*?);/)[1];
      const bstr = atob(base64);
      let n = bstr.length;
      const u8arr = new Uint8Array(n);
      while (n--) u8arr[n] = bstr.charCodeAt(n);
      return new Blob([u8arr], { type: mime });
    }

    // === 7. Generate index.html ===
    function generateIndexHTML() {
      const bgUrl = selectedBg === 'uploaded' ? uploadedDataUrl : 'bg/' + selectedBg;
      const font = fontSelect.value;

      // Escape double quotes in bgUrl for safe insertion into url("...")
      const safeBg = String(bgUrl).replace(/"/g, '\\"');

      // Note: This generator creates a simplified version of index.html
      // The full production version has more features (ETag polling, rules checking, etc.)
      // Consider just updating config.json instead of regenerating the entire file
      
      var html = '';
      html += '<!DOCTYPE html>\n';
      html += '<html lang="en">\n';
      html += '<head>\n';
      html += '  <meta charset="UTF-8" />\n';
      html += '  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>\n';
      html += '  <title>Daily Specials</title>\n';
      html += '  <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"><\/script>\n';
      html += '  <style>\n';
      html += '    * { margin:0; padding:0; box-sizing:border-box; }\n';
      html += '    html, body { height:100%; overflow:hidden; }\n';
      html += '    body {\n';
      html += '      font-family: ' + font + ';\n';
      html += '      color: #fff;\n';
      html += '      text-shadow: 2px 2px 4px rgba(0,0,0,0.7);\n';
      html += '      display: flex;\n';
      html += '      flex-direction: column;\n';
      html += '      position: relative;\n';
      html += '    }\n';
      html += '    /* Background with brightness filter support */\n';
      html += '    body::before {\n';
      html += '      content: \\\'\\\';\n';
      html += '      position: fixed;\n';
      html += '      top: 0;\n';
      html += '      left: 0;\n';
      html += '      width: 100%;\n';
      html += '      height: 100%;\n';
      html += '      background: url("' + safeBg + '") center/cover no-repeat;\n';
      html += '      z-index: -1;\n';
      html += '      filter: brightness(1);\n';
      html += '    }\n';
      html += '    header {\n';
      html += '      background: rgba(0,0,0,0.5);\n';
      html += '      padding: 1rem;\n';
      html += '      text-align: center;\n';
      html += '      font-size: clamp(1.5rem, 5vw, 4rem);\n';
      html += '      font-weight: bold;\n';
      html += '    }\n';
      html += '    #specials {\n';
      html += '      flex: 1;\n';
      html += '      padding: clamp(1rem, 2vw, 3rem);\n';
      html += '      font-size: clamp(1rem, 3vw, 3rem);\n';
      html += '      line-height: 1.6;\n';
      html += '      overflow-y: auto;\n';
      html += '      white-space: pre-wrap;\n';
      html += '      -webkit-overflow-scrolling: touch;\n';
      html += '    }\n';
      html += '    .version { position: fixed; bottom: 0.5rem; right: 0.5rem; font-size: 0.7rem; opacity: 0.5; }\n';
      html += '  </style>\n';
      html += '</head>\n';
      html += '<body>\n';
      html += '  <header>Specials</header>\n';
      html += '  <div id="specials">Loading…</div>\n';
      html += '  <div class="version">314Sign v0.9.1 | © 2025 J Stekervetz | CC BY-NC 4.0</div>\n';
      html += '  <script>\n';
      html += '    const specialsDiv = document.getElementById("specials");\n';
      html += '    let currentMenu = localStorage.getItem("currentMenu") || "menus/dinner.txt";\n';
      html += '    function switchMenu(f) {\n';
      html += '      currentMenu = f;\n';
      html += '      localStorage.setItem("currentMenu", f);\n';
      html += '      fetch(f + "?" + Date.now()).then(r => r.text()).then(t => {\n';
      html += '        specialsDiv.innerHTML = marked.parse(t);\n';
      html += '      });\n';
      html += '    }\n';
      html += '    function checkScheduleRules() {\n';
      html += '      fetch("rules.json?" + Date.now()).then(r => r.ok ? r.json() : null).then(data => {\n';
      html += '        if (!data || !data.enabled || !data.rules) return;\n';
      html += '        const now = new Date();\n';
      html += '        const currentDay = ["sunday","monday","tuesday","wednesday","thursday","friday","saturday"][now.getDay()];\n';
      html += '        const currentTime = now.getHours().toString().padStart(2,"0")+":"+now.getMinutes().toString().padStart(2,"0");\n';
      html += '        for (const rule of data.rules) {\n';
      html += '          if (!rule.days.includes(currentDay)) continue;\n';
      html += '          const startTime = rule.startTime || "00:00";\n';
      html += '          const endTime = rule.endTime || "23:59";\n';
      html += '          let matches = startTime <= endTime ? (currentTime >= startTime && currentTime < endTime) : (currentTime >= startTime || currentTime < endTime);\n';
      html += '          if (matches && rule.menu && rule.menu !== currentMenu) {\n';
      html += '            switchMenu(rule.menu);\n';
      html += '            break;\n';
      html += '          }\n';
      html += '        }\n';
      html += '      });\n';
      html += '    }\n';
      html += '    checkScheduleRules();\n';
      html += '    setInterval(checkScheduleRules, 60000);\n';
      html += '    fetch(currentMenu + "?" + Date.now()).then(r => r.text()).then(t => {\n';
      html += '      let html = marked.parse(t);\n';
      html += '      html = html.replace(/\\\\{r\\\\}(.*?)(<\\\\/|\\\\{[rygbopw]\\\\}|$)/g, \'<span style="color:#ff4444">$1</span>$2\');\n';
      html += '      html = html.replace(/\\\\{y\\\\}(.*?)(<\\\\/|\\\\{[rygbopw]\\\\}|$)/g, \'<span style="color:#ffdd44">$1</span>$2\');\n';
      html += '      html = html.replace(/\\\\{g\\\\}(.*?)(<\\\\/|\\\\{[rygbopw]\\\\}|$)/g, \'<span style="color:#44ff44">$1</span>$2\');\n';
      html += '      html = html.replace(/\\\\{b\\\\}(.*?)(<\\\\/|\\\\{[rygbopw]\\\\}|$)/g, \'<span style="color:#4488ff">$1</span>$2\');\n';
      html += '      html = html.replace(/\\\\{o\\\\}(.*?)(<\\\\/|\\\\{[rygbopw]\\\\}|$)/g, \'<span style="color:#ff8844">$1</span>$2\');\n';
      html += '      html = html.replace(/\\\\{p\\\\}(.*?)(<\\\\/|\\\\{[rygbopw]\\\\}|$)/g, \'<span style="color:#ff44ff">$1</span>$2\');\n';
      html += '      html = html.replace(/\\\\{w\\\\}(.*?)(<\\\\/|\\\\{[rygbopw]\\\\}|$)/g, \'<span style="color:#ffffff">$1</span>$2\');\n';
      html += '      specialsDiv.innerHTML = html;\n';
      html += '    });\n';
      html += '    setInterval(() => fetch(currentMenu + "?" + Date.now()).then(r => r.text()).then(t => {\n';
      html += '      let html = marked.parse(t);\n';
      html += '      html = html.replace(/\\\\{r\\\\}(.*?)(<\\\\/|\\\\{[rygbopw]\\\\}|$)/g, \'<span style="color:#ff4444">$1</span>$2\');\n';
      html += '      html = html.replace(/\\\\{y\\\\}(.*?)(<\\\\/|\\\\{[rygbopw]\\\\}|$)/g, \'<span style="color:#ffdd44">$1</span>$2\');\n';
      html += '      html = html.replace(/\\\\{g\\\\}(.*?)(<\\\\/|\\\\{[rygbopw]\\\\}|$)/g, \'<span style="color:#44ff44">$1</span>$2\');\n';
      html += '      html = html.replace(/\\\\{b\\\\}(.*?)(<\\\\/|\\\\{[rygbopw]\\\\}|$)/g, \'<span style="color:#4488ff">$1</span>$2\');\n';
      html += '      html = html.replace(/\\\\{o\\\\}(.*?)(<\\\\/|\\\\{[rygbopw]\\\\}|$)/g, \'<span style="color:#ff8844">$1</span>$2\');\n';
      html += '      html = html.replace(/\\\\{p\\\\}(.*?)(<\\\\/|\\\\{[rygbopw]\\\\}|$)/g, \'<span style="color:#ff44ff">$1</span>$2\');\n';
      html += '      html = html.replace(/\\\\{w\\\\}(.*?)(<\\\\/|\\\\{[rygbopw]\\\\}|$)/g, \'<span style="color:#ffffff">$1</span>$2\');\n';
      html += '      specialsDiv.innerHTML = html;\n';
      html += '    }), 3000);\n';
      html += '    setInterval(() => location.reload(), 300000);\n';
      html += '  <\/script>\n';
      html += '</body>\n';
      html += '</html>\n';

      return fetch('../index.html', {
        method: 'PUT',
        headers: { 'Content-Type': 'text/html' },
        body: html
      });
    }

    // === Start ===
    // Load backgrounds and then config (which populates fonts)
    loadBackgrounds();
    
    // Also load fonts immediately as a backup to ensure they're available
    setTimeout(() => {
      fetch('../config.json')
        .then(r => r.ok ? r.json() : {})
        .then(cfg => {
          if (cfg.availableFonts && fontSelect.children.length === 0) {
            Object.entries(cfg.availableFonts).forEach(([name, value]) => {
              const option = document.createElement('option');
              option.value = value;
              option.textContent = name;
              fontSelect.appendChild(option);
            });
            if (cfg.font) fontSelect.value = cfg.font;
          }
        })
        .catch(err => console.error('Fallback font load failed:', err));
    }, 100);

    // === Toast helper ===
    (function(){
      // Create styles for toast
      const css = `
      .toast {
        position: fixed;
        left: 50%;
        bottom: max(1.25rem, env(safe-area-inset-bottom));
        transform: translateX(-50%);
        background: rgba(0,0,0,0.85);
        color: #fff;
        padding: 0.75rem 1rem;
        border-radius: 10px;
        font-size: 1rem;
        min-width: 160px;
        max-width: 92%;
        text-align: center;
        z-index: 9999;
        box-shadow: 0 6px 18px rgba(0,0,0,0.25);
        -webkit-backdrop-filter: blur(6px);
        backdrop-filter: blur(6px);
      }
      @media (prefers-reduced-motion: no-preference) {
        .toast.show { animation: toast-in 240ms ease-out; }
      }
      @keyframes toast-in { from { transform: translateX(-50%) translateY(8px); opacity: 0 } to { transform: translateX(-50%) translateY(0); opacity: 1 }}
      `;
      const s = document.createElement('style'); s.textContent = css; document.head.appendChild(s);

      let toastTimer = null;
      window.showToast = function(msg, ms=3000) {
        const el = document.getElementById('toast');
        if (!el) return;
        el.textContent = msg;
        el.style.display = 'block';
        el.classList.add('show');
        if (toastTimer) clearTimeout(toastTimer);
        toastTimer = setTimeout(() => {
          el.classList.remove('show');
          el.style.display = 'none';
        }, ms);
      };
    })();
    
    // === Purge History ===
    function purgeHistory() {
      if (!confirm('⚠️ WARNING: This will permanently delete all menu history files.\n\nAre you sure you want to continue?')) {
        return;
      }
      
      fetch('../purge-history.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      })
        .then(r => r.ok ? r.json() : Promise.reject('Purge failed'))
        .then(data => {
          if (data.success) {
            showToast(`✓ ${data.message}`, 4000);
          } else {
            showToast('✗ Failed to purge history', 4000);
          }
        })
        .catch(err => {
          showToast('✗ Error: ' + err, 4000);
        });
    }
  </script>
</body>
</html>