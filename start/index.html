<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>314Sign Quick Start</title>
  <link rel="icon" type="image/svg+xml" href="../favicon.svg?v=1.0" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
      height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      overscroll-behavior: none;
    }
    .container {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 2rem;
      padding-top: max(2rem, env(safe-area-inset-top));
      padding-bottom: max(2rem, env(safe-area-inset-bottom));
      gap: 2rem;
    }
    .logo {
      text-align: center;
      color: white;
      margin-bottom: 1rem;
    }
    .logo h1 {
      font-size: 3.5rem;
      font-weight: 800;
      margin-bottom: 0.5rem;
      text-shadow: 2px 2px 8px rgba(0,0,0,0.3);
    }
    .logo p {
      font-size: 1.25rem;
      font-weight: 400;
      opacity: 0.95;
      text-shadow: 1px 1px 4px rgba(0,0,0,0.3);
    }
    .cards {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1.5rem;
      width: 100%;
      max-width: 500px;
    }
    @media (min-width: 768px) {
      .cards {
        grid-template-columns: 1fr 1fr;
        max-width: 800px;
      }
    }
    .card {
      background: #2d2d2d;
      border-radius: 20px;
      padding: 2rem;
      text-decoration: none;
      color: #e0e0e0;
      box-shadow: 0 10px 30px rgba(0,0,0,0.4);
      transition: transform 0.2s, box-shadow 0.2s;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      gap: 1rem;
      cursor: pointer;
      min-height: 200px;
      justify-content: center;
    }
    .card:active {
      transform: translateY(2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.4);
    }
    .card-icon {
      font-size: 3.5rem;
      line-height: 1;
    }
    .card-title {
      font-size: 1.75rem;
      font-weight: 700;
      margin-bottom: 0.25rem;
    }
    .card-desc {
      font-size: 1rem;
      color: #b0b0b0;
      line-height: 1.4;
    }
    .card.edit {
      background: linear-gradient(135deg, #5568d3 0%, #6a4c93 100%);
      color: white;
    }
    .card.edit .card-desc {
      color: rgba(255,255,255,0.9);
    }
    .card.rules {
      background: linear-gradient(135deg, #d77fa1 0%, #c94b5c 100%);
      color: white;
    }
    .card.rules .card-desc {
      color: rgba(255,255,255,0.9);
    }
    .card.design {
      background: linear-gradient(135deg, #3a8fd9 0%, #00c4cc 100%);
      color: white;
    }
    .card.design .card-desc {
      color: rgba(255,255,255,0.9);
    }
    .card.view {
      background: linear-gradient(135deg, #36c770 0%, #2ec9b3 100%);
      color: white;
    }
    .card.view .card-desc {
      color: rgba(255,255,255,0.9);
    }
    .footer {
      position: fixed;
      bottom: 1rem;
      left: 50%;
      transform: translateX(-50%);
      color: rgba(255,255,255,0.8);
      font-size: 0.85rem;
      text-align: center;
      text-shadow: 1px 1px 4px rgba(0,0,0,0.3);
      white-space: nowrap;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">
      <h1>314Sign</h1>
      <p>Quick Start Menu</p>
    </div>

    <div class="cards">
      <a href="#" onclick="navigateTo('edit')" class="card edit">
        <div class="card-icon">‚úèÔ∏è</div>
        <div class="card-title">Edit Menus</div>
        <div class="card-desc">Update breakfast, lunch, dinner, and closed messages</div>
      </a>

      <a href="#" onclick="navigateTo('rules')" class="card rules">
        <div class="card-icon">‚è∞</div>
        <div class="card-title">Schedule Rules</div>
        <div class="card-desc">Set automatic menu switching by time of day</div>
      </a>

      <a href="#" onclick="navigateTo('design')" class="card design">
        <div class="card-icon">üé®</div>
        <div class="card-title">Design</div>
        <div class="card-desc">Change background, fonts, colors, and brightness</div>
      </a>

      <a href="#" onclick="navigateTo('slideshows')" class="card" style="background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%); color: white;">
        <div class="card-icon">üìΩÔ∏è</div>
        <div class="card-title">Slideshows</div>
        <div class="card-desc" style="color: rgba(255,255,255,0.9);">Create slideshows with images, videos, and text</div>
      </a>

      <a href="#" onclick="navigateTo('maintenance')" class="card" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); color: white;">
        <div class="card-icon">üîß</div>
        <div class="card-title">Maintenance</div>
        <div class="card-desc" style="color: rgba(255,255,255,0.9);">System health, updates, backups, and history</div>
      </a>

      <a href="../" class="card view">
        <div class="card-icon">üì∫</div>
        <div class="card-title">View Kiosk</div>
        <div class="card-desc">See the live display as customers see it</div>
      </a>
    </div>
  </div>

  <div class="footer">
    <div style="display: flex; align-items: center; gap: 1rem;">
      <span>314Sign v0.9.2.1 | ¬© 2025 J Stekervetz | CC BY-NC 4.0</span>
      <button onclick="logout()" style="background: rgba(220, 53, 69, 0.8); color: white; border: none; padding: 0.25rem 0.75rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">Logout</button>
    </div>
  </div>

  <script>
    // Global token variable
    let token = null;
    let authCheckInProgress = false;
    let authCheckCompleted = false;

    // Initialize authentication
    function initAuth() {
      // Prevent multiple simultaneous auth checks
      if (authCheckInProgress || authCheckCompleted) {
        return;
      }

      authCheckInProgress = true;

      // Get token from URL parameter or localStorage
      const urlParams = new URLSearchParams(window.location.search);
      token = urlParams.get('token') || localStorage.getItem('authToken');

      if (!token) {
        // No token, redirect to login
        authCheckInProgress = false;
        window.location.href = '../login/';
        return;
      } else {
        // Store token for API calls
        localStorage.setItem('authToken', token);

        // Clean up URL (remove token from address bar)
        const url = new URL(window.location);
        url.searchParams.delete('token');
        window.history.replaceState({}, '', url);
      }

      console.log('Starting authentication check...');

      // Verify token on page load - bypass cache to avoid 304 issues
      fetch('/api/auth/me?' + Date.now(), {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Cache-Control': 'no-cache, no-store, must-revalidate',
          'Pragma': 'no-cache',
          'Expires': '0'
        }
      })
      .then(response => {
        console.log('Auth response status:', response.status);
        if (!response.ok) {
          throw new Error('Token invalid');
        }
        return response.json();
      })
      .then(data => {
        authCheckCompleted = true;
        authCheckInProgress = false;

        // Token valid, show user info if needed
        if (data.data && data.data.username) {
          console.log('Authenticated as:', data.data.username);
        } else {
          console.log('Token verified');
        }
      })
      .catch(error => {
        authCheckInProgress = false;
        console.error('Authentication failed:', error);

        // Token invalid, redirect to login
        localStorage.removeItem('authToken');
        localStorage.removeItem('userRole');
        localStorage.removeItem('username');
        window.location.href = '../login/';
      });
    }

    function navigateTo(page) {
      if (token) {
        window.location.href = `../${page}/?token=${token}`;
      } else {
        window.location.href = `../${page}/`;
      }
    }

    function logout() {
      // Clear local storage
      localStorage.removeItem('authToken');
      localStorage.removeItem('userRole');
      localStorage.removeItem('username');

      // Call logout API
      fetch('/api/auth/logout', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`
        }
      }).catch(() => {
        // Ignore errors, just redirect
      });

      // Redirect to login
      window.location.href = '../login/';
    }

    // Initialize when page loads
    initAuth();
  </script>
</body>
</html>
